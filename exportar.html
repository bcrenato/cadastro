<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Administração de Dados</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
body { padding-top: 70px; }
.navbar {
  background-color: #4CAF50; /* verde */
}

.navbar .nav-link,
.navbar .navbar-brand {
  color: #fff;
}

.navbar .nav-link:hover,
.navbar .navbar-brand:hover {
  color: #ddd;
}

/* Estilos para mensagem de não autorizado */
#nao-autorizado {
  margin-top: 100px;
  max-width: 600px;
  margin-left: auto;
  margin-right: auto;
  display: none;
}

/* Oculta conteúdo restrito por padrão */
.conteudo-restrito {
  display: none;
}

body.autorizado .conteudo-restrito {
  display: block;
}

/* Estilos para área de importação */
#import-area {
  border: 2px dashed #ccc;
  padding: 20px;
  text-align: center;
  margin-bottom: 20px;
  border-radius: 5px;
  cursor: pointer;
}

#import-area:hover {
  border-color: #4CAF50;
  background-color: #f8f9fa;
}

#preview-table {
  margin-top: 20px;
  display: none;
}

.progress {
  height: 25px;
  margin-top: 10px;
}

.progress-bar {
  line-height: 25px;
}
</style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark fixed-top">
  <div class="container">
    <a class="navbar-brand" href="#">Administração de Dados</a>
  </div>
</nav>

<div id="nao-autorizado">
  <div class="alert alert-danger text-center">
    <h4><i class="fas fa-exclamation-triangle me-2"></i>Acesso Restrito</h4>
    <p class="mb-4">Você não tem permissão para acessar esta área administrativa.</p>
    <a href="index.html" class="btn btn-primary">
      <i class="fas fa-arrow-left me-2"></i>Voltar à página inicial
    </a>
  </div>
</div>

<div class="container conteudo-restrito mt-4">
  <h1>Administração de Dados</h1>

  <div class="mb-3">
    <label for="formato-exportacao" class="form-label">Formato de exportação:</label>
    <select id="formato-exportacao" class="form-select">
      <option value="csv">CSV</option>
      <option value="json">JSON</option>
      <option value="excel">Excel (XLSX)</option>
    </select>
  </div>

  <button id="btnExportar" class="btn btn-success mb-3">Exportar</button>

  <div class="mb-3">
    <label for="formato-importacao" class="form-label">Formato de importação:</label>
    <select id="formato-importacao" class="form-select">
      <option value="csv">CSV</option>
      <option value="json">JSON</option>
      <option value="excel">Excel (XLSX)</option>
    </select>
  </div>

  <input type="file" id="arquivo-importacao" accept=".csv,.json,.xlsx,.xls" class="form-control mb-3">
  <button id="btnImportar" class="btn btn-primary mb-3">Importar</button>

  <table id="preview-table" class="table table-bordered table-striped" style="display:none;">
    <thead></thead>
    <tbody></tbody>
  </table>

  <div id="mensagens"></div>
  <div class="progress d-none" id="progress-bar">
    <div class="progress-bar"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>

<script type="module">
document.addEventListener("DOMContentLoaded", () => {

  const btnExportar = document.getElementById('btnExportar');
  const btnImportar = document.getElementById('btnImportar');
  const fileInput = document.getElementById('arquivo-importacao');
  const previewTable = document.getElementById('preview-table');
  const mensagens = document.getElementById('mensagens');
  let dadosImportacao = null;

  fileInput.addEventListener('change', handleFileSelection);

  function handleFileSelection() {
    const file = fileInput.files[0];
    if (!file) return;

    const formato = document.getElementById('formato-importacao').value;
    btnImportar.disabled = true;
    previewTable.style.display = 'none';

    const reader = new FileReader();

    if (formato === 'csv' || formato === 'json') {
      reader.onload = function(e) {
        const data = e.target.result;
        if (formato === 'csv') parseCSV(data);
        if (formato === 'json') parseJSON(data);
        btnImportar.disabled = false;
      };
      reader.readAsText(file);
    } else if (formato === 'excel') {
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet);
        dadosImportacao = json;
        const headers = Object.keys(json[0]);
        showPreview(headers, json);
        btnImportar.disabled = false;
      };
      reader.readAsArrayBuffer(file);
    }
  }

  function parseCSV(csv) {
    const lines = csv.split('\n');
    const headers = lines[0].split(',').map(h => h.trim());
    const rows = [];
    for (let i = 1; i < lines.length; i++) {
      if (!lines[i].trim()) continue;
      const values = lines[i].split(',');
      const obj = {};
      headers.forEach((h, j) => obj[h] = values[j] || '');
      rows.push(obj);
    }
    dadosImportacao = rows;
    showPreview(headers, rows);
  }

  function parseJSON(json) {
    const data = JSON.parse(json);
    const rows = Array.isArray(data) ? data : Object.values(data.membros || {});
    const headers = Object.keys(rows[0] || {});
    dadosImportacao = rows;
    showPreview(headers, rows);
  }

  function showPreview(headers, rows) {
    const thead = previewTable.querySelector('thead');
    const tbody = previewTable.querySelector('tbody');
    thead.innerHTML = '';
    tbody.innerHTML = '';
    const headerRow = document.createElement('tr');
    headers.forEach(h => {
      const th = document.createElement('th');
      th.textContent = h;
      headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);

    rows.slice(0, 10).forEach(row => {
      const tr = document.createElement('tr');
      headers.forEach(h => {
        const td = document.createElement('td');
        td.textContent = row[h] || '';
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
    previewTable.style.display = 'table';
  }

  btnExportar.addEventListener('click', () => {
    const formato = document.getElementById('formato-exportacao').value;

    const data = [{
      nome: 'João',
      nascimento: '1990-01-01',
      sexo: 'M',
      telefone: '123456789',
      funcao: 'Membro',
      batismo: '2005',
      endereco: 'Rua A',
      bairro: 'Centro',
      cidade: 'Cidade',
      estado: 'SP',
      cep: '00000-000',
      fotoURL: ''
    }];

    if (formato === 'csv') {
      const csv = Object.keys(data[0]).join(',') + '\n' + 
                  data.map(r => Object.values(r).join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
      saveAs(blob, 'membros.csv');
    } else if (formato === 'json') {
      const json = JSON.stringify(data, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      saveAs(blob, 'membros.json');
    } else if (formato === 'excel') {
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Membros');
      XLSX.writeFile(wb, 'membros.xlsx');
    }
  });

  btnImportar.addEventListener('click', () => {
    if (!dadosImportacao) return;
    showMessage(`Dados importados: ${dadosImportacao.length}`, 'success');
  });

  function showMessage(msg, type = 'info') {
    mensagens.innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
  }

});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
