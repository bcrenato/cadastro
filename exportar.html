<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Administra√ß√£o - Membros</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<style>
body { padding-top: 70px; }
.navbar {
  background-color: #4CAF50;
}
.navbar .nav-link, .navbar .navbar-brand {
  color: #fff;
}
.navbar .nav-link:hover, .navbar .navbar-brand:hover {
  color: #ddd;
}
#nao-autorizado {
  margin-top: 100px;
  max-width: 600px;
  margin-left: auto;
  margin-right: auto;
  display: none;
}
.conteudo-restrito {
  display: none;
}
body.autorizado .conteudo-restrito {
  display: block;
}
</style>
</head>
<body>

<!-- Mensagem de n√£o autorizado -->
<div id="nao-autorizado">
  <div class="alert alert-danger text-center">
    <h4><i class="fas fa-exclamation-triangle me-2"></i>Acesso Restrito</h4>
    <p class="mb-4">Voc√™ n√£o tem permiss√£o para acessar esta √°rea administrativa.</p>
    <a href="index.html" class="btn btn-primary">
      <i class="fas fa-arrow-left me-2"></i>Voltar √† p√°gina inicial
    </a>
  </div>
</div>

<nav class="navbar navbar-expand-lg navbar-dark fixed-top conteudo-restrito">
  <div class="container">
      <a class="navbar-brand" href="#">
        <i class="fas fa-cogs me-2"></i>Administra√ß√£o de Membros
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item">
            <a class="nav-link" href="index.html">
              <i class="fas fa-home me-1"></i> Home
            </a>
          </li>
        </ul>
      </div>
  </div>
</nav>

<div class="container conteudo-restrito">
  <h2 class="mt-4">Exportar / Importar Membros</h2>
  <div class="mb-3">
    <button id="btnExportarExcel" class="btn btn-success">
      <i class="fas fa-file-excel me-1"></i> Exportar para Excel
    </button>
    <input type="file" id="inputImportarExcel" accept=".xlsx" class="form-control mt-2">
  </div>
  <div id="mensagem" class="mt-3"></div>
</div>

<script type="module">
import { auth, db } from './firebase-config.js';
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { ref, get, set } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

async function checkAdmin(user) {
  try {
    if (!user) return false;
    const userRef = ref(db, `users/${user.uid}`);
    const snapshot = await get(userRef);
    if (snapshot.exists()) {
      const userData = snapshot.val();
      return userData.isAdmin === true;
    }
    return false;
  } catch {
    return false;
  }
}

function toggleContent(isAdmin) {
  const authMsg = document.getElementById('nao-autorizado');
  const content = document.querySelectorAll('.conteudo-restrito');
  if (isAdmin) {
    authMsg.style.display = 'none';
    content.forEach(el => el.style.display = 'block');
    document.body.classList.add('autorizado');
  } else {
    authMsg.style.display = 'block';
    content.forEach(el => el.style.display = 'none');
    document.body.classList.remove('autorizado');
  }
}

document.addEventListener('DOMContentLoaded', () => {
  onAuthStateChanged(auth, async (user) => {
    const isAdmin = await checkAdmin(user);
    toggleContent(isAdmin);
  });
});

// EXPORTAR
document.getElementById("btnExportarExcel").addEventListener("click", async () => {
  const membrosRef = ref(db, "membros");
  const snapshot = await get(membrosRef);
  if (!snapshot.exists()) {
    alert("Nenhum membro encontrado.");
    return;
  }

  const data = Object.values(snapshot.val()).map(m => ({
    nome: m.nome || "",
    nascimento: m.nascimento || "",
    sexo: m.sexo || "",
    telefone: m.telefone || "",
    funcao: m.funcao || "",
    batismo: m.batismo || "",
    endereco: m.endereco || "",
    bairro: m.bairro || "",
    cidade: m.cidade || "",
    estado: m.estado || "",
    cep: m.cep || "",
    fotoURL: m.fotoURL || ""
  }));

  const ws = XLSX.utils.json_to_sheet(data, {
    header: [
      "nome", "nascimento", "sexo", "telefone", "funcao", "batismo",
      "endereco", "bairro", "cidade", "estado", "cep", "fotoURL"
    ]
  });
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Membros");
  XLSX.writeFile(wb, "membros.xlsx");
  mostrarMensagem("‚úÖ Exporta√ß√£o conclu√≠da!");
});

// IMPORTAR com substitui√ß√£o total
document.getElementById("inputImportarExcel").addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = async (evt) => {
    const data = evt.target.result;
    const workbook = XLSX.read(data, { type: "binary" });
    const wsname = workbook.SheetNames[0];
    const ws = workbook.Sheets[wsname];
    const json = XLSX.utils.sheet_to_json(ws);

    const membrosRef = ref(db, "membros");

    // üî• REMOVE TODOS OS MEMBROS ANTES DE IMPORTAR
    await set(membrosRef, null);

    let count = 0;

    for (const [index, m] of json.entries()) {
      const novoMembro = {
        nome: m.nome || "",
        nascimento: m.nascimento || "",
        sexo: m.sexo || "",
        telefone: m.telefone || "",
        funcao: m.funcao || "",
        batismo: m.batismo || "",
        endereco: m.endereco || "",
        bairro: m.bairro || "",
        cidade: m.cidade || "",
        estado: m.estado || "",
        cep: m.cep || "",
        fotoURL: m.fotoURL?.trim() ? m.fotoURL : "sem-foto.png"
      };

      const id = `import-${Date.now()}-${index}`;
      await set(ref(db, `membros/${id}`), novoMembro);
      count++;
    }

    mostrarMensagem(`‚úÖ Importa√ß√£o conclu√≠da! ${count} registros salvos (dados anteriores foram substitu√≠dos).`);
    e.target.value = "";
  };

  reader.readAsBinaryString(file);
});

function mostrarMensagem(msg) {
  document.getElementById("mensagem").innerHTML = `
    <div class="alert alert-success alert-dismissible fade show" role="alert">
      ${msg}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  `;
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
