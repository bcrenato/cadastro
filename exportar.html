<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Administra√ß√£o de Dados</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
body { padding-top: 70px; }
.navbar {
  background-color: #4CAF50; /* verde */
}

.navbar .nav-link,
.navbar .navbar-brand {
  color: #fff;
}

.navbar .nav-link:hover,
.navbar .navbar-brand:hover {
  color: #ddd;
}

/* Estilos para mensagem de n√£o autorizado */
#nao-autorizado {
  margin-top: 100px;
  max-width: 600px;
  margin-left: auto;
  margin-right: auto;
  display: none;
}

/* Oculta conte√∫do restrito por padr√£o */
.conteudo-restrito {
  display: none;
}

body.autorizado .conteudo-restrito {
  display: block;
}

/* Estilos para √°rea de importa√ß√£o */
#import-area {
  border: 2px dashed #ccc;
  padding: 20px;
  text-align: center;
  margin-bottom: 20px;
  border-radius: 5px;
  cursor: pointer;
}

#import-area:hover {
  border-color: #4CAF50;
  background-color: #f8f9fa;
}

/* Estilo para tabela de pr√©-visualiza√ß√£o */
#preview-table {
  margin-top: 20px;
  display: none;
}

.progress {
  height: 25px;
  margin-top: 10px;
}

.progress-bar {
  line-height: 25px;
}
</style>
</head>
<body>

<!-- Mensagem de n√£o autorizado -->
<div id="nao-autorizado">
  <div class="alert alert-danger text-center">
    <h4><i class="fas fa-exclamation-triangle me-2"></i>Acesso Restrito</h4>
    <p class="mb-4">Voc√™ n√£o tem permiss√£o para acessar esta √°rea administrativa.</p>
    <a href="index.html" class="btn btn-primary">
      <i class="fas fa-arrow-left me-2"></i>Voltar √† p√°gina inicial
    </a>
  </div>
</div>

<script type="module">
  import { auth, db } from './firebase-config.js';
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import { ref, get } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

  // Verifica se √© admin no Realtime Database
  async function checkAdmin(user) {
    try {
      if (!user) return false;
      
      // Busca os dados do usu√°rio no Realtime Database
      const userRef = ref(db, `users/${user.uid}`);
      const snapshot = await get(userRef);
      
      if (snapshot.exists()) {
        const userData = snapshot.val();
        console.log("Dados do usu√°rio:", userData);
        return userData.isAdmin === true;
      }
      
      return false;
    } catch (error) {
      console.error("Erro na verifica√ß√£o:", error);
      return false;
    }
  }

  // Controla a exibi√ß√£o do conte√∫do
  function toggleContent(isAdmin) {
    const authMsg = document.getElementById('nao-autorizado');
    const content = document.querySelectorAll('.conteudo-restrito');
    
    if (isAdmin) {
      console.log("Acesso concedido: usu√°rio √© admin");
      authMsg.style.display = 'none';
      content.forEach(el => el.style.display = 'block');
      document.body.classList.add('autorizado');
    } else {
      console.log("Acesso negado: usu√°rio n√£o √© admin");
      authMsg.style.display = 'block';
      content.forEach(el => el.style.display = 'none');
      document.body.classList.remove('autorizado');
    }
  }

  // Quando a p√°gina carrega
  document.addEventListener('DOMContentLoaded', () => {
    onAuthStateChanged(auth, async (user) => {
      const isAdmin = await checkAdmin(user);
      toggleContent(isAdmin);
    });
  });
</script>




  <!-- üîπ Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark fixed-top conteudo-restrito">
  <div class="container">
      <a class="navbar-brand" href="#">
        <i class="fas fa-database me-2"></i>Administra√ß√£o de Dados
      </a>
    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav me-auto">
        <!-- Bot√£o Home -->
        <li class="nav-item">
          <a class="nav-link" href="index.html">
            <i class="fas fa-home me-1"></i> Home
          </a>
        </li>
        <!-- Bot√£o Listagem -->
        <li class="nav-item">
          <a class="nav-link" href="listagem.html">
            <i class="fas fa-list me-1"></i> Lista de Membros
          </a>
        </li>
        <!-- Bot√£o Exportar -->
        <li class="nav-item">
          <a class="nav-link" href="exportar.html">
            <i class="fas fa-file-export me-1"></i> Exportar Dados
          </a>
        </li>
      </ul>
    </div>
  </div> 
</nav>

<div class="container mt-4 conteudo-restrito">
  <!-- Mensagens de feedback -->
  <div id="mensagens"></div>
  
  <div class="row">
    <div class="col-md-6">
      <div class="card mb-4">
        <div class="card-header bg-primary text-white">
          <i class="fas fa-file-export me-2"></i>Exportar Dados
        </div>
        <div class="card-body">
          <div class="mb-3">
            <label class="form-label">Formato:</label>
            <select id="formato-exportacao" class="form-select">
              <option value="csv">CSV (Excel e outros)</option>
              <option value="excel">Excel (XLSX)</option>
              <option value="json">JSON (Backup completo)</option>
            </select>
          </div>
          <button id="btnExportar" class="btn btn-success">
            <i class="fas fa-download me-2"></i>Exportar Dados
          </button>
        </div>
      </div>
    </div>
    
    <div class="col-md-6">
      <div class="card mb-4">
        <div class="card-header bg-warning text-dark">
          <i class="fas fa-file-import me-2"></i>Importar Dados
        </div>
        <div class="card-body">
          <div class="mb-3">
            <label class="form-label">Formato:</label>
            <select id="formato-importacao" class="form-select">
              <option value="csv">CSV</option>
              <option value="xlsx">Excel (XLSX)</option>
              <option value="json">JSON (Backup completo)</option>
            </select>
          </div>
          
          <div id="import-area" class="mb-3">
            <i class="fas fa-cloud-upload-alt fa-3x mb-3"></i>
            <p>Arraste e solte seu arquivo aqui ou clique para selecionar</p>
            <input type="file" id="arquivo-importacao" class="d-none" accept=".csv,.json,.xlsx,.xls">
          </div>
          
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="sobrescrever-dados">
            <label class="form-check-label" for="sobrescrever-dados">
              Sobrescrever dados existentes?
            </label>
          </div>
          
          <button id="btnImportar" class="btn btn-primary" disabled>
            <i class="fas fa-upload me-2"></i>Importar Dados
          </button>
          
          <div class="progress mt-3 d-none" id="progress-bar">
            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                 role="progressbar" style="width: 0%">0%</div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Tabela de pr√©-visualiza√ß√£o -->
  <div class="card">
    <div class="card-header">
      <i class="fas fa-table me-2"></i>Pr√©-visualiza√ß√£o dos Dados
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table id="preview-table" class="table table-striped table-bordered">
          <thead class="table-primary"></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- FileSaver.js como script global -->
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

<!-- SheetJS (para exporta√ß√£o Excel) -->
<script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>





 <!-- Script principal -->
<script type="module">
// Refer√™ncia global para FileSaver
const { saveAs } = window;

import { db } from './firebase-config.js';
import { ref, get, set, update } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

// Elementos da interface
const btnExportar = document.getElementById('btnExportar');
const btnImportar = document.getElementById('btnImportar');
const importArea = document.getElementById('import-area');
const fileInput = document.getElementById('arquivo-importacao');
const previewTable = document.getElementById('preview-table');
const mensagens = document.getElementById('mensagens');
const progressBar = document.getElementById('progress-bar');

// Ordem dos campos (sua requisi√ß√£o)
const ordemCampos = [
  'nome', 'nascimento', 'sexo', 'telefone', 'funcao',
  'batismo', 'endereco', 'bairro', 'cidade', 'estado', 'cep', 'fotoURL'
];

// Vari√°vel global para dados importados
let dadosImportacao = null;

// ====================== FUN√á√ïES ESSENCIAIS ======================

// Fun√ß√£o para mostrar mensagens (corrigida)
function showMessage(text, type) {
  const alertDiv = document.createElement('div');
  alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
  alertDiv.innerHTML = `
    <div class="d-flex align-items-center">
      <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} me-2"></i>
      <div>${text}</div>
      <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  `;
  
  mensagens.innerHTML = '';
  mensagens.appendChild(alertDiv);

  setTimeout(() => {
    alertDiv.classList.remove('show');
    setTimeout(() => alertDiv.remove(), 150);
  }, 5000);
}

// Fun√ß√£o para pr√©-visualiza√ß√£o
function showPreview(headers, rows) {
  const thead = previewTable.querySelector('thead');
  const tbody = previewTable.querySelector('tbody');
  
  thead.innerHTML = '';
  tbody.innerHTML = '';
  
  // Cabe√ßalhos
  const headerRow = document.createElement('tr');
  ordemCampos.forEach(header => {
    const th = document.createElement('th');
    th.textContent = header;
    headerRow.appendChild(th);
  });
  thead.appendChild(headerRow);
  
  // Dados (limitado a 10 registros)
  const maxRows = Math.min(10, rows.length);
  for (let i = 0; i < maxRows; i++) {
    const tr = document.createElement('tr');
    ordemCampos.forEach(campo => {
      const td = document.createElement('td');
      td.textContent = rows[i][campo] || '';
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  }
  
  previewTable.style.display = 'table';
}

// ====================== IMPORTAR XLSX (NOVO) ======================
function parseXLSX(file) {
  const reader = new FileReader();
  
  reader.onload = function(e) {
    try {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
      const jsonData = XLSX.utils.sheet_to_json(firstSheet);

      // Processar dados conforme sua requisi√ß√£o
      const dadosFormatados = jsonData.map(item => {
        const novoItem = {};
        ordemCampos.forEach(campo => {
          // Tratar fotoURL vazia
          if (campo === 'fotoURL') {
            novoItem[campo] = (!item[campo] || item[campo].toString().trim() === '') 
              ? 'sem-foto.png' 
              : item[campo];
          } else {
            novoItem[campo] = item[campo] || '';
          }
        });
        return novoItem;
      });

      dadosImportacao = dadosFormatados;
      showPreview(ordemCampos, dadosFormatados);
      btnImportar.disabled = false;
      
    } catch (error) {
      showMessage(`Falha ao ler arquivo Excel: ${error.message}`, 'danger');
      console.error("Erro XLSX:", error);
    }
  };
  
  reader.readAsArrayBuffer(file);
}

// ====================== EXPORTAR XLSX (ATUALIZADO) ======================
async function exportToExcel(data) {
  try {
    // Preparar dados com ordem correta
    const dadosOrdenados = data.map(membro => {
      const novoMembro = {};
      ordemCampos.forEach(campo => {
        novoMembro[campo] = (campo === 'fotoURL' && !membro[campo]) 
          ? 'sem-foto.png' 
          : membro[campo] || '';
      });
      return novoMembro;
    });

    // Criar planilha
    const ws = XLSX.utils.json_to_sheet(dadosOrdenados, { header: ordemCampos });
    
    // Ajustar largura das colunas
    ws['!cols'] = ordemCampos.map(campo => ({ 
      wch: campo === 'nome' ? 25 : 
           campo === 'endereco' ? 30 : 
           campo === 'fotoURL' ? 20 : 15 
    }));

    // Gerar arquivo
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Membros");
    XLSX.writeFile(wb, `membros_${new Date().toISOString().slice(0,10)}.xlsx`);
    
    showMessage('Planilha exportada com sucesso!', 'success');
    
  } catch (error) {
    showMessage(`Erro na exporta√ß√£o: ${error.message}`, 'danger');
    throw error;
  }
}

// ====================== CONFIGURA√á√ÉO DE EVENTOS ======================

// Importa√ß√£o de arquivos
fileInput.addEventListener('change', function() {
  const file = this.files[0];
  if (!file) return;

  const formato = document.getElementById('formato-importacao').value;
  btnImportar.disabled = true;
  previewTable.style.display = 'none';

  if (formato === 'xlsx') {
    parseXLSX(file);
  } else {
    // ... (seu c√≥digo existente para CSV/JSON)
  }
});

// Exporta√ß√£o para Excel
btnExportar.addEventListener('click', async () => {
  try {
    btnExportar.disabled = true;
    btnExportar.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Exportando...';
    
    const snapshot = await get(ref(db, 'membros'));
    if (!snapshot.exists()) {
      showMessage('Nenhum dado encontrado para exportar', 'warning');
      return;
    }
    
    await exportToExcel(Object.values(snapshot.val()));
    
  } catch (error) {
    console.error("Erro exporta√ß√£o:", error);
  } finally {
    btnExportar.disabled = false;
    btnExportar.innerHTML = '<i class="fas fa-file-excel me-2"></i>Exportar Excel';
  }
});

// ... (seus outros event listeners)
</script>

<!-- Depend√™ncias -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script type="module" src="js/session-timeout.js"></script>
</body>
</html>
