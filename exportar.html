<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Administração de Membros</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
body { padding-top: 70px; }
.navbar { background-color: #4CAF50; }
.navbar .nav-link, .navbar .navbar-brand { color: #fff; }
.navbar .nav-link:hover, .navbar .navbar-brand:hover { color: #ddd; }
#nao-autorizado {
  margin-top: 100px; max-width: 600px;
  margin-left: auto; margin-right: auto; display: none;
}
.conteudo-restrito { display: none; }
body.autorizado .conteudo-restrito { display: block; }
</style>
</head>
<body>

<div id="nao-autorizado">
  <div class="alert alert-danger text-center">
    <h4><i class="fas fa-exclamation-triangle me-2"></i>Acesso Restrito</h4>
    <p>Você não tem permissão para acessar esta área administrativa.</p>
    <a href="index.html" class="btn btn-primary"><i class="fas fa-arrow-left me-2"></i>Voltar</a>
  </div>
</div>

<nav class="navbar navbar-expand-lg navbar-dark fixed-top conteudo-restrito">
<div class="container">
  <a class="navbar-brand" href="#"><i class="fas fa-database me-2"></i>Administração</a>
</div>
</nav>

<div class="container mt-4 conteudo-restrito">
  <h3>Exportar/Importar Membros</h3>
  <div class="mb-3">
    <button id="exportar" class="btn btn-success"><i class="fas fa-file-export me-1"></i>Exportar Excel</button>
    <input type="file" id="importar" class="form-control mt-2" accept=".xlsx" />
  </div>
  <div id="status" class="mt-3"></div>
</div>

<script type="module">
import { auth, db } from './firebase-config.js';
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { ref, set, get, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

async function checkAdmin(user) {
  if (!user) return false;
  const userRef = ref(db, `users/${user.uid}`);
  const snapshot = await get(userRef);
  if (snapshot.exists()) {
    const userData = snapshot.val();
    return userData.isAdmin === true;
  }
  return false;
}

function toggleContent(isAdmin) {
  const authMsg = document.getElementById('nao-autorizado');
  const content = document.querySelectorAll('.conteudo-restrito');
  if (isAdmin) {
    authMsg.style.display = 'none';
    content.forEach(el => el.style.display = 'block');
    document.body.classList.add('autorizado');
  } else {
    authMsg.style.display = 'block';
    content.forEach(el => el.style.display = 'none');
    document.body.classList.remove('autorizado');
  }
}

document.addEventListener('DOMContentLoaded', () => {
  onAuthStateChanged(auth, async (user) => {
    const isAdmin = await checkAdmin(user);
    toggleContent(isAdmin);
  });
});
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script type="module">
import { db } from './firebase-config.js';
import { ref, set, get, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const btnExportar = document.getElementById("exportar");
const inputImportar = document.getElementById("importar");
const statusDiv = document.getElementById("status");

function formatDateToDisplay(dateStr) {
  const [y, m, d] = dateStr.split("-");
  return `${d}/${m}/${y}`;
}

function formatDateToDB(dateStr) {
  const [d, m, y] = dateStr.split("/");
  return `${y}-${m}-${d}`;
}

btnExportar.addEventListener("click", async () => {
  const snapshot = await get(ref(db, "membros"));
  if (!snapshot.exists()) {
    alert("Nenhum membro encontrado.");
    return;
  }

  const data = Object.entries(snapshot.val()).map(([id, m]) => {
    return {
      nome: m.nome || "",
      nascimento: m.nascimento ? formatDateToDisplay(m.nascimento) : "",
      sexo: m.sexo || "",
      telefone: m.telefone || "",
      funcao: m.funcao || "",
      batismo: m.batismo ? formatDateToDisplay(m.batismo) : "",
      endereco: m.endereco || "",
      bairro: m.bairro || "",
      cidade: m.cidade || "",
      estado: m.estado || "",
      cep: m.cep || "",
      fotoURL: m.fotoURL || ""
    };
  });

  const ws = XLSX.utils.json_to_sheet(data, {header: [
    "nome","nascimento","sexo","telefone","funcao","batismo",
    "endereco","bairro","cidade","estado","cep","fotoURL"
  ]});
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Membros");

  XLSX.writeFile(wb, "membros.xlsx");
});

inputImportar.addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = async (evt) => {
    const data = evt.target.result;
    const workbook = XLSX.read(data, {type: 'binary'});
    const ws = workbook.Sheets[workbook.SheetNames[0]];
    const jsonData = XLSX.utils.sheet_to_json(ws);

    const updates = {};
    jsonData.forEach((m, index) => {
      const id = `membro_${index+1}`;
      updates[id] = {
        nome: m.nome || "",
        nascimento: m.nascimento ? formatDateToDB(m.nascimento) : "",
        sexo: m.sexo || "",
        telefone: m.telefone || "",
        funcao: m.funcao || "",
        batismo: m.batismo ? formatDateToDB(m.batismo) : "",
        endereco: m.endereco || "",
        bairro: m.bairro || "",
        cidade: m.cidade || "",
        estado: m.estado || "",
        cep: m.cep || "",
        fotoURL: m.fotoURL || "sem-foto.png"
      };
    });

    const membrosRef = ref(db, "membros");
    await remove(membrosRef);
    await set(membrosRef, updates);

    statusDiv.innerHTML = `<div class="alert alert-success mt-2">✅ Importação concluída. ${jsonData.length} membros importados.</div>`;
  };
  reader.readAsBinaryString(file);
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script type="module" src="js/session-timeout.js"></script>
</body>
</html>
