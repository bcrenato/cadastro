<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Carteirinhas de Membros</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .carteirinha {
      position: relative;
      width: 19cm;
      height: 6.5cm;
      margin-bottom: 1cm;
      page-break-after: always;
      overflow: hidden;
    }
    .carteirinha img.fundo {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
    }
    .info {
      position: absolute;
      color: #000;
      font-size: 11pt;
      font-family: Arial, sans-serif;
      z-index: 1;
    }
    .nome { top: 3cm; left: 1cm; width: 7cm; }
    .rg { top: 4.1cm; left: 1cm; width: 7cm; }
    .cargo { top: 4.75cm; left: 1.5cm; width: 7cm; }
    .batismo { top: 5.7cm; left: 1cm; width: 3cm; }
    .nascimento { top: 5.6cm; left: 4.5cm; width: 3cm; }
    .validade { top: 5.6cm; left: 16.3cm; width: 4cm; }
    .foto {
      top: 2.95cm;
      left: 7.0cm;
      width: 2.1cm;
      height: 3.1cm;
      object-fit: cover;
      border-radius: 4px;
      position: absolute;
      z-index: 1;
    }
  </style>
</head>
<body class="container py-4">
  <h2 class="mb-3">Impressão de Carteirinhas</h2>
  <input id="searchInput" class="form-control mb-3" placeholder="Buscar membro...">
  <div id="membersList" class="list-group mb-3"></div>
  <button class="btn btn-primary" onclick="gerarCarteirinhas()">Gerar PDF</button>
  <div id="cardPreview" style="display: none;"></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCv6pzl34tyPTARtGxV6g2AJfkrtQeA-xU",
      authDomain: "cadastro-igreja-23042.firebaseapp.com",
      databaseURL: "https://cadastro-igreja-23042-default-rtdb.firebaseio.com",
      projectId: "cadastro-igreja-23042",
      storageBucket: "cadastro-igreja-23042.firebasestorage.app",
      messagingSenderId: "977906864836",
      appId: "1:977906864836:web:1a21a29f4b941ac5aeaf91"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let membros = [];
    let selecionados = [];
    const lista = document.getElementById('membersList');
    const preview = document.getElementById('cardPreview');

    firebase.auth().onAuthStateChanged((user) => {
      if (user) {
        carregarMembros();
      } else {
        alert("Você precisa estar logado para acessar as carteirinhas.");
        window.location.href = "../index.html";
      }
    });

    function carregarMembros() {
      db.ref('membros').once('value', snapshot => {
        snapshot.forEach(child => {
          const m = { id: child.key, ...child.val() };
          membros.push(m);
          lista.innerHTML += `<div class='list-group-item'>
            <input type='checkbox' value='${m.id}' onchange='selecionar(this)'>
            ${m.nome} - ${m.funcao || ''}
          </div>`;
        });
      });
    }

    function selecionar(cb) {
      if (cb.checked) selecionados.push(cb.value);
      else selecionados = selecionados.filter(id => id !== cb.value);
    }

    document.getElementById("searchInput").addEventListener("input", function() {
      const termo = this.value.toLowerCase();
      lista.innerHTML = '';
      membros.filter(m => m.nome.toLowerCase().includes(termo)).forEach(m => {
        lista.innerHTML += `<div class='list-group-item'>
          <input type='checkbox' value='${m.id}' onchange='selecionar(this)' ${selecionados.includes(m.id) ? 'checked' : ''}>
          ${m.nome} - ${m.funcao || ''}
        </div>`;
      });
    });

async function gerarCarteirinhas() {
  preview.innerHTML = '';
  const selecionadosMembros = membros.filter(m => selecionados.includes(m.id));
  const fundoCarteirinha = "https://bcrenato.github.io/cadastro/img/carteirinha.png";

  // Configurações do PDF
  const pdf = new jspdf.jsPDF({
    orientation: 'portrait',
    unit: 'cm',
    format: 'a4'
  });

  // Dimensões
  const cardWidth = 19; // largura da carteirinha
  const cardHeight = 6.5; // altura da carteirinha
  const a4Width = 21.0; // largura A4
  const a4Height = 29.7; // altura A4
  const marginTop = 1.5; // margem superior
  const spacing = 0.5; // espaço entre carteirinhas

  let yPosition = marginTop; // posição vertical inicial

  for (let i = 0; i < selecionadosMembros.length; i++) {
    const m = selecionadosMembros[i];
    const div = document.createElement('div');
    div.className = 'carteirinha';
    div.style.width = `${cardWidth}cm`;
    div.style.height = `${cardHeight}cm`;
    
    // Fallback para foto
    const fallbackFoto = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyMDAgMjAwIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2RkZCIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBkb21pbmFudC1iYXNlbGluZT0ibWlkZGxlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjNjY2IiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMjQiPk5lbmh1bWEgZm90bzwvdGV4dD48L3N2Zz4=';
    let fotoMembro = m.fotoURL || fallbackFoto;
    
    div.innerHTML = `
      <img src="${fundoCarteirinha}" class="fundo" crossorigin="anonymous">
      <div class='info nome'>${m.nome || ''}</div>
      <div class='info rg'>${m.rg || ''}</div>
      <div class='info cargo'>${m.funcao || ''}</div>
      <div class='info batismo'>${m.batismo || ''}</div>
      <div class='info nascimento'>${m.nascimento || ''}</div>
      <div class='info validade'>2025</div>
      <img class='foto' src='${fotoMembro}' crossorigin="anonymous" onerror="this.src='${fallbackFoto}'">
    `;
    document.body.appendChild(div);

    try {
      const canvas = await html2canvas(div, {
        useCORS: true,
        allowTaint: false,
        scale: 2,
        logging: true,
        imageTimeout: 10000,
        backgroundColor: null
      });

      const imgData = canvas.toDataURL('image/png', 1.0);
      
      if (!imgData || !imgData.startsWith('data:image/png')) {
        throw new Error('Falha ao gerar imagem da carteirinha');
      }

      // Verifica se precisa de nova página
      if (yPosition + cardHeight > a4Height - marginTop) {
        pdf.addPage('a4', 'portrait');
        yPosition = marginTop; // reinicia na margem superior
      }

      // Centraliza horizontalmente
      const xPosition = (a4Width - cardWidth) / 2;
      
      pdf.addImage(imgData, 'PNG', xPosition, yPosition, cardWidth, cardHeight);
      
      // Atualiza a posição Y para a próxima carteirinha
      yPosition += cardHeight + spacing;
      
    } catch (error) {
      console.error('Erro ao gerar carteirinha:', error);
      alert(`Erro ao gerar carteirinha para ${m.nome}. Verifique o console.`);
    } finally {
      document.body.removeChild(div);
    }
  }
  
  pdf.save('carteirinhas.pdf');
}
  </script>
</body>
</html>
