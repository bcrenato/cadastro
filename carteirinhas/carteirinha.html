async function gerarCarteirinhas() {
  preview.innerHTML = '';
  const selecionadosMembros = membros.filter(m => selecionados.includes(m.id));
  const fundoCarteirinha = "https://bcrenato.github.io/cadastro/img/carteirinha.png";

  // Configurações do PDF
  const pdf = new jspdf.jsPDF({
    orientation: 'portrait',
    unit: 'cm',
    format: 'a4'
  });

  // Dimensões
  const cardWidth = 19; // largura da carteirinha
  const cardHeight = 6.5; // altura da carteirinha
  const a4Width = 21.0; // largura A4
  const a4Height = 29.7; // altura A4
  const marginTop = 1.5; // margem superior
  const spacing = 0.5; // espaço entre carteirinhas

  let yPosition = marginTop; // posição vertical inicial

  for (let i = 0; i < selecionadosMembros.length; i++) {
    const m = selecionadosMembros[i];
    const div = document.createElement('div');
    div.className = 'carteirinha';
    div.style.width = `${cardWidth}cm`;
    div.style.height = `${cardHeight}cm`;
    
    // Fallback para foto
    const fallbackFoto = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyMDAgMjAwIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2RkZCIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBkb21pbmFudC1iYXNlbGluZT0ibWlkZGxlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjNjY2IiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMjQiPk5lbmh1bWEgZm90bzwvdGV4dD48L3N2Zz4=';
    let fotoMembro = m.fotoURL || fallbackFoto;
    
    div.innerHTML = `
      <img src="${fundoCarteirinha}" class="fundo" crossorigin="anonymous">
      <div class='info nome'>${m.nome || ''}</div>
      <div class='info rg'>${m.rg || ''}</div>
      <div class='info cargo'>${m.funcao || ''}</div>
      <div class='info batismo'>${m.batismo || ''}</div>
      <div class='info nascimento'>${m.nascimento || ''}</div>
      <div class='info validade'>2025</div>
      <img class='foto' src='${fotoMembro}' crossorigin="anonymous" onerror="this.src='${fallbackFoto}'">
    `;
    document.body.appendChild(div);

    try {
      const canvas = await html2canvas(div, {
        useCORS: true,
        allowTaint: false,
        scale: 2,
        logging: true,
        imageTimeout: 10000,
        backgroundColor: null
      });

      const imgData = canvas.toDataURL('image/png', 1.0);
      
      if (!imgData || !imgData.startsWith('data:image/png')) {
        throw new Error('Falha ao gerar imagem da carteirinha');
      }

      // Verifica se precisa de nova página
      if (yPosition + cardHeight > a4Height - marginTop) {
        pdf.addPage('a4', 'portrait');
        yPosition = marginTop; // reinicia na margem superior
      }

      // Centraliza horizontalmente
      const xPosition = (a4Width - cardWidth) / 2;
      
      pdf.addImage(imgData, 'PNG', xPosition, yPosition, cardWidth, cardHeight);
      
      // Atualiza a posição Y para a próxima carteirinha
      yPosition += cardHeight + spacing;
      
    } catch (error) {
      console.error('Erro ao gerar carteirinha:', error);
      alert(`Erro ao gerar carteirinha para ${m.nome}. Verifique o console.`);
    } finally {
      document.body.removeChild(div);
    }
  }
  
  pdf.save('carteirinhas.pdf');
}
