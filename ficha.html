<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ficha do Membro</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

  <style>
    #foto {
      width: 150px;
      height: 150px;
      object-fit: cover;
      border-radius: 50%;
      box-shadow: 0 0 8px rgba(0,0,0,0.3);
      display: block;
      margin: 0 auto 15px;
    }
    .edit-mode {
      display: none;
    }
    #fotoPreview {
      width: 150px;
      height: 150px;
      object-fit: cover;
      border-radius: 50%;
      margin: 0 auto 15px;
      display: block;
    }
    #fotoInput {
      display: none;
    }
    .foto-container {
      position: relative;
      margin: 0 auto;
      width: 150px;
    }
    .foto-upload-btn {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background: rgba(0,0,0,0.5);
      color: white;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    .header-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>

  <!-- üîπ SCRIPT DE VERIFICA√á√ÉO DE AUTENTICA√á√ÉO -->
  <script type="module">
  import { checkAuth } from './auth.js';
  checkAuth();
  </script>

  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
      <a class="navbar-brand" href="#">Cadastro Igreja</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="index.html">Cadastro</a></li>
          <li class="nav-item"><a class="nav-link" href="listagem.html">Listagem</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <main class="container my-5" style="max-width: 450px;">
    <div class="header-actions">
      <h2 class="mb-0">Ficha do Membro</h2>
      <button id="editBtn" class="btn btn-primary">Editar</button>
    </div>
    
    <div class="card p-4 shadow-sm">
      <!-- Modo Visualiza√ß√£o -->
      <div id="viewMode">
        <img id="foto" alt="Foto do membro" />
        <p><strong>Nome:</strong> <span id="nome"></span></p>
        <p><strong>CEP:</strong> <span id="cep"></span></p>
        <p><strong>Endere√ßo:</strong> <span id="endereco"></span></p>
        <p><strong>Bairro:</strong> <span id="bairro"></span></p>
        <p><strong>Cidade:</strong> <span id="cidade"></span></p>
        <p><strong>Estado:</strong> <span id="estado"></span></p>
        <p><strong>Data de Batismo:</strong> <span id="batismo"></span></p>
        <p><strong>Data de Nascimento:</strong> <span id="nascimento"></span></p>
        <p><strong>Fun√ß√£o:</strong> <span id="funcao"></span></p>
        <p><strong>Telefone:</strong> <span id="telefone"></span></p>
        <p><strong>Sexo:</strong> <span id="sexo"></span></p>
        <a href="listagem.html" class="btn btn-outline-primary mt-3">‚Üê Voltar para lista</a>
      </div>

      <!-- Modo Edi√ß√£o -->
      <form id="editMode" class="edit-mode">
        <div class="foto-container">
          <img id="fotoPreview" alt="Preview da foto" />
          <label for="fotoInput" class="foto-upload-btn">
            <i class="bi bi-camera"></i>
          </label>
          <input type="file" id="fotoInput" accept="image/*" />
        </div>

        <div class="mb-3">
          <label for="editNome" class="form-label">Nome</label>
          <input type="text" class="form-control" id="editNome" required>
        </div>
        <div class="mb-3">
          <label for="editCep" class="form-label">CEP</label>
          <input type="text" class="form-control" id="editCep">
        </div>
        <div class="mb-3">
          <label for="editEndereco" class="form-label">Endere√ßo</label>
          <input type="text" class="form-control" id="editEndereco">
        </div>
        <div class="mb-3">
          <label for="editBairro" class="form-label">Bairro</label>
          <input type="text" class="form-control" id="editBairro">
        </div>
        <div class="mb-3">
          <label for="editCidade" class="form-label">Cidade</label>
          <input type="text" class="form-control" id="editCidade">
        </div>
        <div class="mb-3">
          <label for="editEstado" class="form-label">Estado</label>
          <input type="text" class="form-control" id="editEstado">
        </div>
        <div class="mb-3">
          <label for="editBatismo" class="form-label">Data de Batismo</label>
          <input type="date" class="form-control" id="editBatismo">
        </div>
        <div class="mb-3">
          <label for="editNascimento" class="form-label">Data de Nascimento</label>
          <input type="date" class="form-control" id="editNascimento">
        </div>
        <div class="mb-3">
          <label for="editFuncao" class="form-label">Fun√ß√£o</label>
          <select class="form-select" id="editFuncao" required>
            <option value="">Selecione uma fun√ß√£o</option>
            <option value="Pastor">Pastor</option>
            <option value="Mission√°rio(a)">Mission√°rio(a)</option>
            <option value="Di√°cono">Di√°cono</option>
            <option value="Obreiro(a)">Obreiro(a)</option>
            <option value="Membro">Membro</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="editTelefone" class="form-label">Telefone</label>
          <input type="tel" class="form-control" id="editTelefone">
        </div>
        <div class="mb-3">
          <label for="editSexo" class="form-label">Sexo</label>
          <select class="form-select" id="editSexo">
            <option value="Masculino">Masculino</option>
            <option value="Feminino">Feminino</option>
            <option value="Outro">Outro</option>
          </select>
        </div>
        <div class="d-flex justify-content-between mt-3">
          <button type="button" id="cancelEditBtn" class="btn btn-outline-secondary">Cancelar</button>
          <button type="submit" class="btn btn-primary">Salvar</button>
        </div>
      </form>
    </div>
  </main>

  <script type="module">
    import { db, storage } from './firebase-config.js';
    import { ref, get, update } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
    import { ref as storageRef, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get('id');
    let membroData = {};
    let currentFotoURL = '';

    // Elementos do DOM
    const viewMode = document.getElementById('viewMode');
    const editMode = document.getElementById('editMode');
    const editBtn = document.getElementById('editBtn');
    const cancelEditBtn = document.getElementById('cancelEditBtn');
    const fotoInput = document.getElementById('fotoInput');
    const fotoPreview = document.getElementById('fotoPreview');
    const fotoView = document.getElementById('foto');

    // Fun√ß√£o para alternar entre modos de visualiza√ß√£o e edi√ß√£o
    function toggleEditMode(isEditing) {
      if (isEditing) {
        viewMode.style.display = 'none';
        editMode.style.display = 'block';
        editBtn.style.display = 'none';
      } else {
        viewMode.style.display = 'block';
        editMode.style.display = 'none';
        editBtn.style.display = 'block';
      }
    }

    // Carregar dados do membro
    if (!id) {
      document.querySelector('.card').innerHTML = '<p class="text-danger">Membro n√£o encontrado.</p>';
    } else {
      const membroRef = ref(db, `membros/${id}`);

      get(membroRef).then((snapshot) => {
        if (snapshot.exists()) {
          membroData = snapshot.val();
          currentFotoURL = membroData.fotoURL || '';

          // Preencher modo visualiza√ß√£o
          document.getElementById("nome").textContent = membroData.nome || '';
          document.getElementById("cep").textContent = membroData.cep || '';
          document.getElementById("endereco").textContent = membroData.endereco || '';
          document.getElementById("bairro").textContent = membroData.bairro || '';
          document.getElementById("cidade").textContent = membroData.cidade || '';
          document.getElementById("estado").textContent = membroData.estado || '';
          document.getElementById("batismo").textContent = membroData.batismo || '';
          document.getElementById("nascimento").textContent = membroData.nascimento || '';
          document.getElementById("funcao").textContent = membroData.funcao || '';
          document.getElementById("telefone").textContent = membroData.telefone || '';
          document.getElementById("sexo").textContent = membroData.sexo || '';

          if (membroData.fotoURL) {
            fotoView.src = membroData.fotoURL;
            fotoView.style.display = "block";
            fotoPreview.src = membroData.fotoURL;
          } else {
            fotoView.style.display = "none";
            fotoPreview.src = "https://via.placeholder.com/150?text=Sem+Foto";
          }

          // Preencher formul√°rio de edi√ß√£o
          document.getElementById("editNome").value = membroData.nome || '';
          document.getElementById("editCep").value = membroData.cep || '';
          document.getElementById("editEndereco").value = membroData.endereco || '';
          document.getElementById("editBairro").value = membroData.bairro || '';
          document.getElementById("editCidade").value = membroData.cidade || '';
          document.getElementById("editEstado").value = membroData.estado || '';
          document.getElementById("editBatismo").value = membroData.batismo || '';
          document.getElementById("editNascimento").value = membroData.nascimento || '';
          document.getElementById("editTelefone").value = membroData.telefone || '';
          document.getElementById("editSexo").value = membroData.sexo || 'Masculino';

          // Preencher o campo de fun√ß√£o
          const funcoes = ["Pastor", "Mission√°rio(a)", "Di√°cono", "Obreiro(a)", "Membro"];
          const funcaoSelect = document.getElementById("editFuncao");
          const funcaoAtual = membroData.funcao || "";

          if (funcaoAtual && !funcoes.includes(funcaoAtual)) {
            const option = document.createElement("option");
            option.value = funcaoAtual;
            option.textContent = funcaoAtual;
            option.selected = true;
            funcaoSelect.appendChild(option);
          }

          funcaoSelect.value = funcaoAtual || "Membro";
        } else {
          document.querySelector('.card').innerHTML = '<p class="text-danger">Membro n√£o encontrado.</p>';
        }
      }).catch((error) => {
        console.error("Erro ao buscar membro:", error);
      });
    }

    // Event Listeners
    editBtn.addEventListener('click', () => toggleEditMode(true));
    cancelEditBtn.addEventListener('click', () => toggleEditMode(false));

    // Upload de nova foto
    fotoInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
          fotoPreview.src = event.target.result;
        };
        reader.readAsDataURL(file);
      }
    });

    // Envio do formul√°rio de edi√ß√£o
    editMode.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      let fotoURL = currentFotoURL;
      let shouldDeleteOldPhoto = false;
      
      // Se uma nova foto foi selecionada
      if (fotoInput.files[0]) {
        try {
          // Se havia uma foto antiga, marcamos para deletar
          if (currentFotoURL) {
            shouldDeleteOldPhoto = true;
          }
          
          // Upload da nova foto
          const file = fotoInput.files[0];
          const fileRef = storageRef(storage, `membros/${id}/${file.name}`);
          await uploadBytes(fileRef, file);
          fotoURL = await getDownloadURL(fileRef);
        } catch (error) {
          console.error("Erro ao fazer upload da foto:", error);
          alert("Erro ao atualizar a foto. Os outros dados foram salvos.");
        }
      }
      
      // Atualizar dados no banco de dados
      const updatedData = {
        nome: document.getElementById("editNome").value,
        cep: document.getElementById("editCep").value,
        endereco: document.getElementById("editEndereco").value,
        bairro: document.getElementById("editBairro").value,
        cidade: document.getElementById("editCidade").value,
        estado: document.getElementById("editEstado").value,
        batismo: document.getElementById("editBatismo").value,
        nascimento: document.getElementById("editNascimento").value,
        funcao: document.getElementById("editFuncao").value,
        telefone: document.getElementById("editTelefone").value,
        sexo: document.getElementById("editSexo").value,
        fotoURL: fotoURL
      };

      try {
        await update(ref(db, `membros/${id}`), updatedData);
        
        // Se tudo deu certo, deletar a foto antiga se necess√°rio
        if (shouldDeleteOldPhoto) {
          try {
            const oldPhotoRef = storageRef(storage, currentFotoURL);
            await deleteObject(oldPhotoRef);
          } catch (error) {
            console.error("Erro ao deletar foto antiga:", error);
          }
        }
        
        // Atualizar a visualiza√ß√£o com os novos dados
        membroData = updatedData;
        currentFotoURL = fotoURL;
        
        document.getElementById("nome").textContent = updatedData.nome;
        document.getElementById("cep").textContent = updatedData.cep;
        document.getElementById("endereco").textContent = updatedData.endereco;
        document.getElementById("bairro").textContent = updatedData.bairro;
        document.getElementById("cidade").textContent = updatedData.cidade;
        document.getElementById("estado").textContent = updatedData.estado;
        document.getElementById("batismo").textContent = updatedData.batismo;
        document.getElementById("nascimento").textContent = updatedData.nascimento;
        document.getElementById("funcao").textContent = updatedData.funcao;
        document.getElementById("telefone").textContent = updatedData.telefone;
        document.getElementById("sexo").textContent = updatedData.sexo;
        
        if (fotoURL) {
          fotoView.src = fotoURL;
          fotoView.style.display = "block";
        } else {
          fotoView.style.display = "none";
        }
        
        toggleEditMode(false);
        alert("Dados atualizados com sucesso!");
      } catch (error) {
        console.error("Erro ao atualizar membro:", error);
        alert("Erro ao atualizar membro. Por favor, tente novamente.");
      }
    });

    // Inicializar visualiza√ß√£o
    toggleEditMode(false);
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
