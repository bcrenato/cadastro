
<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gerenciar Usuários - Sistema Igreja</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<style>
  body { padding-top: 70px; background-color: #f8f9fa; }
  .navbar { background-color: #4CAF50; }
  .navbar .nav-link, .navbar .navbar-brand { color: #fff; }
  .navbar .nav-link:hover, .navbar .navbar-brand:hover { color: #ddd; }
  .btn-primary { background-color: #28a745; border-color: #28a745; }
  .btn-primary:hover { background-color: #218838; border-color: #1e7e34; }
  .admin-card { border-left: 4px solid #ffc107; }
</style>
</head>
<body>

<script type="module">
import { checkAdminAuth } from './auth.js';
if (!await checkAdminAuth()) { window.location.href = 'index.html'; }
</script>

<nav class="navbar navbar-expand-lg navbar-dark fixed-top">
  <div class="container">
    <a class="navbar-brand" href="index.html">
      <i class="fas fa-user-shield me-2"></i> Gerenciar Usuários
    </a>
  </div>
</nav>

<div class="container mt-4">
<div class="row">
<div class="col-lg-6 mb-4">
<div class="card admin-card shadow">
<div class="card-header bg-white"><h3 class="text-center mb-0"><i class="fas fa-user-plus text-primary me-2"></i> Cadastrar Novo Usuário</h3></div>
<div class="card-body">
<form id="registerForm">
<div class="mb-3"><label for="fullName" class="form-label"><i class="fas fa-user me-1"></i> Nome Completo</label><input type="text" id="fullName" class="form-control" required></div>
<div class="mb-3"><label for="username" class="form-label"><i class="fas fa-at me-1"></i> Nome de Usuário</label><input type="text" id="username" class="form-control" required></div>
<div class="mb-3"><label for="password" class="form-label"><i class="fas fa-lock me-1"></i> Senha</label><input type="password" id="password" class="form-control" required minlength="6"></div>
<div class="mb-3 form-check"><input type="checkbox" id="isAdmin" class="form-check-input"><label for="isAdmin" class="form-check-label"><i class="fas fa-user-shield me-1"></i> É administrador?</label></div>
<button type="submit" class="btn btn-primary w-100 py-2"><i class="fas fa-save me-2"></i> Cadastrar Usuário</button>
</form>
</div></div></div>

<div class="col-lg-6">
<div class="card admin-card shadow">
<div class="card-header bg-white"><h3 class="text-center mb-0"><i class="fas fa-users text-primary me-2"></i> Usuários Cadastrados</h3></div>
<div class="card-body">
<div class="table-responsive">
<table class="table table-hover user-table">
<thead><tr><th>Nome</th><th>Usuário</th><th>Tipo</th><th>Habilitado</th><th>Ações</th></tr></thead>
<tbody id="usersList"></tbody>
</table></div></div></div></div></div></div>

<div id="toastContainer" class="toast-container"></div>

<script type="module">
import { db, auth } from './firebase-config.js';
import { ref, get, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
import { registerUser, getAllUsers, deleteUser, toggleUserEnabled } from './users.js';

const usersList = document.getElementById('usersList');
const registerForm = document.getElementById('registerForm');

async function loadUsers() {
  try {
    const users = await getAllUsers();
    usersList.innerHTML = '';
    if (users.length === 0) {
      usersList.innerHTML = '<tr><td colspan="5" class="text-center">Nenhum usuário cadastrado</td></tr>';
      return;
    }
    users.forEach(user => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${user.fullName || 'Não informado'}</td>
        <td>${user.username}</td>
        <td>${user.isAdmin ? 'Admin' : 'Usuário'}</td>
        <td><input type="checkbox" class="enable-user" data-id="${user.id}" ${user.isEnabled ? 'checked' : ''}></td>
        <td><button class="btn btn-sm btn-danger delete-user" data-id="${user.id}"><i class="fas fa-trash"></i> Excluir</button></td>
      `;
      usersList.appendChild(row);
    });
    document.querySelectorAll('.enable-user').forEach(checkbox => {
      checkbox.addEventListener('change', async () => {
        const userId = checkbox.getAttribute('data-id');
        const enabled = checkbox.checked;
        try {
          await toggleUserEnabled(userId, enabled);
          showToast(`Usuário ${enabled ? 'habilitado' : 'desabilitado'}`);
        } catch (err) {
          showToast('Erro ao atualizar status', 'danger');
          checkbox.checked = !enabled;
        }
      });
    });
    document.querySelectorAll('.delete-user').forEach(btn => {
      btn.addEventListener('click', async () => {
        const userId = btn.getAttribute('data-id');
        if (confirm('Deseja excluir este usuário?')) {
          try {
            await deleteUser(userId);
            showToast('Usuário excluído com sucesso');
            loadUsers();
          } catch (err) {
            showToast(err.message, 'danger');
          }
        }
      });
    });
  } catch (err) {
    showToast('Erro ao carregar usuários', 'danger');
  }
}

registerForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  try {
    await registerUser(
      document.getElementById('username').value,
      document.getElementById('password').value,
      document.getElementById('fullName').value,
      document.getElementById('isAdmin').checked
    );
    showToast('Usuário cadastrado com sucesso!');
    registerForm.reset();
    loadUsers();
  } catch (error) {
    showToast(error.message, 'danger');
  }
});

function showToast(message, type = 'success') {
  const toast = document.createElement('div');
  toast.className = `toast show align-items-center text-white bg-${type}`;
  toast.role = 'alert';
  toast.innerHTML = `<div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
  document.getElementById('toastContainer').appendChild(toast);
  setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 3000);
}

document.addEventListener('DOMContentLoaded', () => loadUsers());
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body></html>
