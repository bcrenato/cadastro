<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin - Relógio de Oração</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="icon" href="data:,">
<style>
body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f5f5f5; }
.container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
h1 { color: #333; border-bottom: 1px solid #eee; padding-bottom: 10px; }
table { width: 100%; border-collapse: collapse; margin-top: 20px; }
th, td { padding: 12px 15px; border: 1px solid #ddd; text-align: left; }
th { background-color: #f2f2f2; font-weight: bold; }
tr:nth-child(even) { background-color: #f9f9f9; }
.btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
.btn-edit { background-color: #4CAF50; color: white; }
.btn-delete { background-color: #f44336; color: white; }
.btn-add { background-color: #2196F3; color: white; padding: 10px 15px; margin-bottom: 20px; }
</style>
</head>

<body>

<script type="module">
import { checkAuth } from '../auth.js';
const user = await checkAuth();
if (!user) {
  window.location.href = '../login.html';
}
</script>

<div class="container">
  <a href="../relogio/" class="btn btn-outline-secondary">
    <i class="fas fa-arrow-left"></i> Voltar para o Relógio
  </a>

  <h1>Painel Admin - Relógio de Oração</h1>

  <button class="btn btn-add" id="btnAddHorario">
    <i class="fas fa-plus"></i> Adicionar Horário
  </button>

  <table id="horariosTable">
    <thead>
      <tr>
        <th>Horário</th>
        <th>Nome</th>
        <th>Status</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody id="horariosBody">
      <tr><td colspan="4">Carregando...</td></tr>
    </tbody>
  </table>
</div>

<script type="module">
import { checkAuth } from '../auth.js';
import { db } from '../firebase-config.js';

const user = await checkAuth();

if (!user) {
  window.location.href = '../login.html';
} else {
  console.log('Usuário autenticado:', user.email);
  startAdmin();
}

function startAdmin() {
  const horariosRef = db.ref('relogio/horarios');

  function loadHorarios() {
    horariosRef.on('value', (snapshot) => {
      renderHorarios(snapshot.val());
    });
  }

  function renderHorarios(horarios) {
    const tbody = document.getElementById('horariosBody');
    tbody.innerHTML = '';

    if (!horarios) {
      tbody.innerHTML = '<tr><td colspan="4">Nenhum horário cadastrado</td></tr>';
      return;
    }

    Object.keys(horarios).forEach((key) => {
      const horario = horarios[key];
      const row = document.createElement('tr');

      row.innerHTML = `
        <td>${key}</td>
        <td>${horario.nome_reserva || ''}</td>
        <td>${horario.reservado ? 'Reservado' : 'Disponível'}</td>
        <td>
          <button class="btn btn-edit" data-horario="${key}">Editar</button>
          <button class="btn btn-delete" data-horario="${key}">Excluir</button>
        </td>
      `;

      tbody.appendChild(row);
    });

    document.querySelectorAll('.btn-edit').forEach(btn => {
      btn.addEventListener('click', () => openEditModal(btn.dataset.horario));
    });
    document.querySelectorAll('.btn-delete').forEach(btn => {
      btn.addEventListener('click', () => confirmDelete(btn.dataset.horario));
    });
  }

  function openEditModal(horarioKey) {
    const nome = prompt(`Editar nome do horário ${horarioKey}:`);
    if (nome === null) return;
    const reservado = nome.trim() !== '';
    horariosRef.child(horarioKey).update({
      nome_reserva: nome,
      reservado: reservado,
      data_reserva: reservado ? new Date().toISOString() : ''
    });
  }

  function confirmDelete(horarioKey) {
    if (confirm(`Tem certeza que deseja excluir o horário ${horarioKey}?`)) {
      horariosRef.child(horarioKey).remove();
    }
  }

  document.getElementById('btnAddHorario').addEventListener('click', () => {
    const horario = prompt('Informe o novo horário (ex: 08:00):');
    if (!horario) return;
    horariosRef.child(horario).set({
      reservado: false,
      nome_reserva: '',
      data_reserva: ''
    });
  });

  loadHorarios();
}
</script>

</body>
</html>
