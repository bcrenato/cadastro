<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gerenciar Permissões</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
</head>
<body class="container py-4">
<h1>Permissões por Página</h1>
<div id="permissoes-container"></div>
<button id="salvar" class="btn btn-success mt-3">Salvar</button>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCv6pzl34tyPTARtGxV6g2AJfkrtQeA-xU",
  authDomain: "cadastro-igreja-23042.firebaseapp.com",
  databaseURL: "https://cadastro-igreja-23042-default-rtdb.firebaseio.com",
  projectId: "cadastro-igreja-23042",
  messagingSenderId: "977906864836",
  appId: "1:977906864836:web:1a21a29f4b941ac5aeaf91"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

const paginas = [
  "index.html",
  "cadastro-membros.html",
  "listagem.html",
  "aniversariantes.html",
  "relogio/index.html",
  "presenca/lista.html",
  "backup.html",
  "register.html"
];
const roles = ["admin", "membro", "secretario"];

auth.onAuthStateChanged(async user => {
  if (!user) {
    alert("Faça login.");
    window.location.href = "login.html";
    return;
  }

  const userSnap = await db.ref(`users/${user.uid}`).get();
  if (!userSnap.exists() || !userSnap.val().isAdmin) {
    alert("Acesso restrito a administradores.");
    window.location.href = "index.html";
    return;
  }

  carregarPermissoes();
});

function carregarPermissoes() {
  db.ref("permissoes").get().then(snap => {
    const permissoes = snap.val() || {};
    const container = document.getElementById("permissoes-container");
    container.innerHTML = "";

    paginas.forEach(pagina => {
      const div = document.createElement("div");
      div.classList.add("mb-3");
      div.innerHTML = `<strong>${pagina}</strong><br>`;
      roles.forEach(role => {
        const checked = permissoes[pagina]?.includes(role) ? "checked" : "";
        div.innerHTML += `
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" id="${pagina}-${role}" ${checked}>
            <label class="form-check-label" for="${pagina}-${role}">${role}</label>
          </div>`;
      });
      container.appendChild(div);
    });
  });
}

document.getElementById("salvar").addEventListener("click", () => {
  const novasPermissoes = {};
  paginas.forEach(pagina => {
    novasPermissoes[pagina] = [];
    roles.forEach(role => {
      const cb = document.getElementById(`${pagina}-${role}`);
      if (cb.checked) novasPermissoes[pagina].push(role);
    });
  });

  db.ref("permissoes").set(novasPermissoes)
    .then(() => alert("Permissões salvas!"))
    .catch(err => alert("Erro: " + err));
});
</script>
</body>
</html>
