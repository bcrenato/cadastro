<script>
  document.getElementById("btnExportarPDF").addEventListener("click", () => {
    const doc = new window.jsPDFGlobal({ orientation: "landscape", unit: "mm", format: "a4" });

    const logoUrl = "./logo.png"; // Caminho da sua logo
    const img = new Image();
    img.crossOrigin = "anonymous";
    img.src = logoUrl;

    img.onload = function () {
      const pageWidth = doc.internal.pageSize.getWidth();
      const logoWidth = 40; // Altere aqui se quiser um logo maior/menor
      const logoHeight = (img.height / img.width) * logoWidth;
      const logoX = (pageWidth - logoWidth) / 2;

      // Cabeçalho
      doc.addImage(img, 'PNG', logoX, 10, logoWidth, logoHeight);
      doc.setFontSize(14);
      doc.text("Igreja XXX", pageWidth / 2, 10 + logoHeight + 7, { align: "center" });
      doc.text("Lista completa de membros", pageWidth / 2, 10 + logoHeight + 15, { align: "center" });

      const cabecalhoY = 10 + logoHeight + 25;

      // Obter dados do Firebase
      import("./firebase-config.js").then(({ db }) => {
        import("https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js").then(firebase => {
          const { ref, get, child } = firebase;

          get(child(ref(db), "membros")).then(snapshot => {
            if (!snapshot.exists()) return alert("Nenhum membro encontrado.");

            const data = snapshot.val();
            const membrosArray = Object.values(data).map(m => ([
              m.nome || "", m.nascimento || "", m.sexo || "", m.telefone || "",
              m.funcao || "", m.batismo || "", m.endereco || "", m.bairro || "",
              m.cidade || "", m.estado || ""
            ]));

            // Configurar autoTable
            doc.autoTable({
              startY: cabecalhoY,
              head: [[
                "Nome", "Nascimento", "Sexo", "Telefone", "Função",
                "Batismo", "Endereço", "Bairro", "Cidade", "Estado"
              ]],
              body: membrosArray,
              styles: { fontSize: 8, cellPadding: 2 },
              margin: { top: cabecalhoY, bottom: 15 },
              didDrawPage: function (data) {
                const pageCount = doc.internal.getNumberOfPages();
                const pageSize = doc.internal.pageSize;
                const pageHeight = pageSize.getHeight();
                const pageWidth = pageSize.getWidth();

                const currentPage = doc.internal.getCurrentPageInfo().pageNumber;

                // Rodapé
                doc.setFontSize(8);
                doc.text(`Página ${currentPage} de ${pageCount}`, pageWidth / 2, pageHeight - 7, { align: "center" });

                const now = new Date();
                const geradoEm = now.toLocaleString("pt-BR", {
                  day: "2-digit", month: "2-digit", year: "numeric",
                  hour: "2-digit", minute: "2-digit"
                });
                doc.text(`Gerado em: ${geradoEm}`, pageWidth - 10, pageHeight - 7, { align: "right" });
              },
              headStyles: {
                fillColor: [41, 128, 185],
                halign: 'center'
              },
              columnStyles: {
                0: { cellWidth: 40 }, // Nome
                1: { cellWidth: 25 }, // Nascimento
                2: { cellWidth: 20 }, // Sexo
                3: { cellWidth: 30 }, // Telefone
                4: { cellWidth: 25 }, // Função
                5: { cellWidth: 25 }, // Batismo
                6: { cellWidth: 45 }, // Endereço
                7: { cellWidth: 25 }, // Bairro
                8: { cellWidth: 25 }, // Cidade
                9: { cellWidth: 20 }  // Estado
              }
            });

            doc.save("lista_membros.pdf");
          });
        });
      });
    };
  });
</script>
