<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lista de Membros</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <style>
    body {
      padding-top: 70px;
    }
    .foto-miniatura {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border-radius: 50%;
      margin-right: 10px;
    }
    .membro-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px;
      border-bottom: 1px solid #ddd;
    }
    .info-membro {
      display: flex;
      align-items: center;
      text-decoration: none;
      color: inherit;
      flex-grow: 1;
    }
    .checkbox-selecao {
      display: none;
    }
  </style>
</head>
<body>

  <!-- Script de verificação de autenticação -->
  <script type="module">
    import { checkAuth } from './auth.js';
    import { isUserAdmin } from './users.js';
    
    document.addEventListener('DOMContentLoaded', async () => {
      const user = await checkAuth();
      
      // Mostrar menu admin se o usuário for administrador
      if (user && await isUserAdmin()) {
        document.getElementById('adminMenuItem').style.display = 'block';
      }

      // Mostrar nome do usuário logado
      if (user) {
        document.getElementById('currentUserDisplay').querySelector('span').textContent = user.email || 'Usuário';
      }

      // Configurar logout
      document.getElementById('logoutBtn').addEventListener('click', () => {
        firebase.auth().signOut().then(() => {
          window.location.href = 'login.html';
        });
      });
    });
  </script>

  <!-- Navbar fixa no topo -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
    <div class="container">
      <a class="navbar-brand" href="index.html">Listagem</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item">
            <a class="nav-link" href="index.html">
              <i class="fas fa-user-plus me-1"></i> Cadastro
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="listagem.html">
              <i class="fas fa-list me-1"></i> Listagem
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="aniversariantes.html">
              <i class="fas fa-birthday-cake me-1"></i> Aniversariantes
            </a>
          </li>
          
          <!-- Menu de Admin (só aparece para administradores) -->
          <li class="nav-item" id="adminMenuItem" style="display: none;">
            <a class="nav-link" href="register.html">
              <i class="fas fa-user-shield me-1"></i> Cadastrar Usuários
            </a>
          </li>
        </ul>
        
        <div class="d-flex align-items-center">
          <!-- Nome do usuário logado -->
          <span class="navbar-text text-white me-3" id="currentUserDisplay">
            <i class="fas fa-user-circle me-1"></i>
            <span>Carregando...</span>
          </span>
          
          <!-- Botão de Logout -->
          <button id="logoutBtn" class="btn btn-sm btn-outline-light">
            <i class="fas fa-sign-out-alt me-1"></i> Sair
          </button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Conteúdo -->
  <div class="container mt-4">
    <!-- Botões de ação -->
    <div class="mb-3 d-flex justify-content-between">
      <button id="btnSelecionar" class="btn btn-secondary">Selecionar Cadastros</button>
      <div>
        <button id="btnExcluir" class="btn btn-danger d-none me-2">Excluir Selecionados</button>
        <button id="btnExportar" class="btn btn-success">
          <i class="fas fa-file-pdf me-1"></i> Exportar PDF
        </button>
      </div>
    </div>

    <!-- Lista de membros -->
    <div id="lista-membros" class="list-group"></div>
  </div>

  <!-- Scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <!-- Firebase + lógica -->
  <script type="module">
    import { db } from './firebase-config.js';
    import { ref, onValue, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    const lista = document.getElementById("lista-membros");
    const btnSelecionar = document.getElementById("btnSelecionar");
    const btnExcluir = document.getElementById("btnExcluir");
    const btnExportar = document.getElementById("btnExportar");
    let modoSelecao = false;

    const membrosRef = ref(db, "membros");

    // Função para carregar os membros
    function carregarMembros(data) {
      lista.innerHTML = "";

      if (!data) {
        lista.innerHTML = "<p class='text-center'>Nenhum membro cadastrado.</p>";
        return;
      }

      for (const id in data) {
        const membro = data[id];
        const item = document.createElement("div");
        item.className = "list-group-item membro-item";

        item.innerHTML = `
          <input type="checkbox" class="form-check-input me-2 checkbox-selecao" data-id="${id}">
          <a href="ficha.html?id=${id}" class="info-membro">
            <img src="${membro.fotoURL || ''}" class="foto-miniatura" alt="Foto" onerror="this.src='./sem-foto.jpg'">
            <div>
              <div><strong>${membro.nome}</strong></div>
              <small>${membro.funcao}</small>
            </div>
          </a>
        `;

        lista.appendChild(item);
      }

      atualizarVisibilidadeCheckboxes();
    }

    // Alterna visibilidade dos checkboxes
    function atualizarVisibilidadeCheckboxes() {
      const checkboxes = document.querySelectorAll(".checkbox-selecao");
      checkboxes.forEach(cb => {
        cb.style.display = modoSelecao ? "inline-block" : "none";
      });

      btnExcluir.classList.toggle("d-none", !modoSelecao);
      btnSelecionar.textContent = modoSelecao ? "Cancelar Seleção" : "Selecionar Cadastros";
    }

    // Alternar seleção
    btnSelecionar.addEventListener("click", () => {
      modoSelecao = !modoSelecao;
      atualizarVisibilidadeCheckboxes();
    });

    // Excluir selecionados
    btnExcluir.addEventListener("click", () => {
      const selecionados = document.querySelectorAll(".checkbox-selecao:checked");
      if (selecionados.length === 0) {
        alert("Nenhum cadastro selecionado.");
        return;
      }

      if (!confirm("Tem certeza que deseja excluir os cadastros selecionados?")) return;

      selecionados.forEach(cb => {
        const id = cb.getAttribute("data-id");
        remove(ref(db, `membros/${id}`));
      });
    });

    // Exportar para PDF
btnExportar.addEventListener("click", async () => {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({
    orientation: "portrait",
    unit: "mm",
    format: "a4",
    compress: true
  });

  // Estilos
  const styles = {
    titleFontSize: 12,
    subtitleFontSize: 12,
    textFontSize: 10,
    margin: 15,
    lineHeight: 5,
  };

  // Cabeçalho com logo acima do título
try {
    const logoUrl = './logo.png'; // Define o caminho para a imagem do logo
    const logoResponse = await fetch(logoUrl); // Faz uma requisição para buscar o arquivo do logo
    const logoBlob = await logoResponse.blob(); // Converte a resposta em um objeto Blob (binário)
    const logoDataUrl = await new Promise((resolve) => {
      const reader = new FileReader(); // Cria um leitor de arquivos
      reader.onload = () => resolve(reader.result); // Resolve a Promise quando o carregamento estiver completo
      reader.readAsDataURL(logoBlob); // Lê o Blob como URL de dados (base64)
    }); // Converte o Blob para uma URL de dados que pode ser usada na tag <img>
    
    // Criar uma imagem temporária para obter as dimensões originais
    const img = new Image(); // Cria um elemento de imagem HTML não renderizado
    img.src = logoDataUrl; // Define a fonte da imagem como a URL de dados
    await new Promise((resolve) => {
      img.onload = resolve; // Aguarda até que a imagem seja carregada
    }); // Garante que as dimensões da imagem estarão disponíveis
    
    // Dimensões originais do logo
    const originalWidth = img.width; // Largura original da imagem em pixels
    const originalHeight = img.height; // Altura original da imagem em pixels
    const aspectRatio = originalHeight / originalWidth; // Calcula a proporção entre altura e largura
    
    // Largura desejada para o logo no PDF (em mm)
    const desiredWidth = 80; // Define a largura desejada para o logo no PDF (em milímetros)
    
    // Calcular altura proporcional
    const proportionalHeight = desiredWidth * aspectRatio; // Calcula a altura mantendo a proporção original
    
    // Adiciona o logo centralizado acima do título
    const pageWidth = doc.internal.pageSize.getWidth(); // Obtém a largura da página do PDF (A4 = 210mm)
    const logoX = (pageWidth - desiredWidth) / 2; // Calcula a posição X para centralizar o logo
    
    doc.addImage(logoDataUrl, 'PNG', logoX, 10, desiredWidth, proportionalHeight); // Insere a imagem no PDF
    
    // Texto do cabeçalho abaixo do logo
    doc.setFont("helvetica", "bold"); // Define a fonte para o título
    doc.setFontSize(styles.titleFontSize); // Define o tamanho da fonte
    doc.text("Famílias Vivendo na Graça e Unção do Espírito", 105, 10 + proportionalHeight + 5, { align: "center" }); // Adiciona o texto principal
    
    doc.setFontSize(styles.subtitleFontSize); // Define tamanho menor para o subtítulo
    doc.text("Lista Completa de Membros", 105, 10 + proportionalHeight + 13, { align: "center" }); // Adiciona subtítulo
    
    // Linha divisória (ajustada para ficar abaixo do título)
    doc.setDrawColor(200, 200, 200); // Define cor cinza para a linha (RGB)
    doc.setLineWidth(0.3); // Define espessura fina para a linha
    const lineY = 10 + proportionalHeight + 20; // Calcula posição Y da linha baseado no logo e títulos
    doc.line(styles.margin, lineY, 210 - styles.margin, lineY); // Desenha linha horizontal
    
    // Ajusta a posição inicial do conteúdo
    let yPosition = lineY + 10; // Define a posição inicial para o conteúdo principal

} catch (error) {
    console.error("Erro ao carregar o logo:", error); // Log de erro se houver problemas com o logo
    
    // Se houver erro no logo, usa apenas o texto
    doc.setFont("helvetica", "bold"); // Define fonte para o título alternativo
    doc.setFontSize(styles.titleFontSize); // Tamanho do título
    doc.text("Famílias Vivendo na Graça e Unção do Espírito", 105, 20, { align: "center" }); // Título sem logo
    
    doc.setFontSize(styles.subtitleFontSize); // Tamanho do subtítulo
    doc.text("Lista Completa de Membros", 105, 28, { align: "center" }); // Subtítulo sem logo
    
    // Linha divisória
    doc.setDrawColor(200, 200, 200); // Cor da linha
    doc.setLineWidth(0.3); // Espessura da linha
    doc.line(styles.margin, 33, 210 - styles.margin, 33); // Desenha linha
    
    // Posição inicial do conteúdo sem logo
    let yPosition = 40; // Posição Y inicial mais baixa sem logo
}

// Carrega os dados
const snapshot = await new Promise(resolve =>
    onValue(ref(db, "membros"), resolve, { onlyOnce: true })
); // Obtém dados dos membros do Firebase (uma única vez)

const membros = []; // Array para armazenar os membros
for (const id in snapshot.val()) {
    membros.push(snapshot.val()[id]); // Adiciona cada membro ao array
} // Preenche o array com dados do Firebase

// Ordena por nome
membros.sort((a, b) => a.nome.localeCompare(b.nome)); // Ordena alfabeticamente pelo nome

// Configurações da tabela
let yPosition = 50; // Posição Y inicial do conteúdo (ajustado para cabeçalho com logo)
const col1 = styles.margin; // Posição X da primeira coluna (margem esquerda)
const colWidth = (210 - (2 * styles.margin)) / 2; // Largura de cada coluna (divide espaço restante)

// Adiciona membros
doc.setFont("helvetica", "normal"); // Fonte normal para o conteúdo
doc.setFontSize(styles.textFontSize); // Tamanho da fonte para os dados

membros.forEach((membro, index) => {
    if (yPosition > 270) { // Verifica se atingiu o final da página
        doc.addPage(); // Adiciona nova página
        yPosition = 20; // Reinicia posição Y
    } // Controla quebra de página
    
    // Dados formatados
    const dados = [ // Array com informações formatadas de cada membro
        `Nome: ${membro.nome || 'Não informado'}`, // Nome com fallback
        `Nascimento: ${membro.nascimento ? new Date(membro.nascimento).toLocaleDateString('pt-BR') : 'Não informado'}`, // Data formatada
        `Sexo: ${membro.sexo || 'Não informado'}`, // Sexo
        `Telefone: ${membro.telefone || 'Não informado'}`, // Telefone
        `Função: ${membro.funcao || 'Não informado'}`, // Função
        `Batismo: ${membro.batismo ? new Date(membro.batismo).toLocaleDateString('pt-BR') : 'Não informado'}`, // Data de batismo
        `Endereço: ${ // Endereço completo formatado
            [
                membro.endereco,
                membro.bairro,
                membro.cidade,
                membro.estado
            ]
            .filter(Boolean) // Remove campos vazios
            .join(', ') // Junta com vírgula
            || 'Não informado' // Fallback se não houver endereço
        }`
    ];

    // Adiciona os dados em duas colunas
    let x = col1; // Posição X inicial (primeira coluna)
    let maxHeight = 0; // Controla altura máxima da linha
    
    dados.forEach((texto, i) => {
        const textHeight = doc.splitTextToSize(texto, colWidth - 5).length * styles.lineHeight; // Calcula altura do texto
        doc.text(texto, x, yPosition, { maxWidth: colWidth - 5 }); // Adiciona texto com largura máxima
        
        if (i % 2 === 1) { // Se for item ímpar (segunda coluna)
            yPosition += Math.max(styles.lineHeight * 2, textHeight); // Move para próxima linha
            x = col1; // Volta para primeira coluna
        } else { // Se for item par (primeira coluna)
            x += colWidth; // Move para segunda coluna
            maxHeight = Math.max(maxHeight, textHeight); // Atualiza altura máxima
        }
    });

    // Linha divisória entre membros
    doc.setDrawColor(220, 220, 220); // Cor cinza claro
    doc.setLineWidth(0.8); // Espessura média
    yPosition += 6; // Espaço antes da linha
    doc.line(styles.margin, yPosition, 210 - styles.margin, yPosition); // Desenha linha
    
    yPosition += 5; // Espaço após a linha
});

// Rodapé
const dataHora = new Date().toLocaleString('pt-BR', { // Formata data e hora
    day: '2-digit', // Dia com 2 dígitos
    month: '2-digit', // Mês com 2 dígitos
    year: 'numeric', // Ano completo
    hour: '2-digit', // Hora com 2 dígitos
    minute: '2-digit', // Minutos com 2 dígitos
    hour12: false // Formato 24h
}).replace(',', ' às'); // Substitui vírgula por "às"

doc.setFontSize(8); // Fonte pequena para rodapé
doc.setTextColor(150, 150, 150); // Cor cinza
doc.text(`Gerado em ${dataHora} • Famílias Vivendo na Graça e Unção do Espírito`, 105, 287, { align: "center" }); // Texto centralizado no rodapé

      // Salva o PDF
      doc.save(`Lista_de_Membros_${new Date().getFullYear()}.pdf`);
    });

    // Carrega os dados do Firebase
    onValue(membrosRef, (snapshot) => {
      const data = snapshot.val();
      carregarMembros(data);
    });
  </script>
</body>
</html>
