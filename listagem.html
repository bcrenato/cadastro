<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Lista de Membros</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
body { padding-top: 70px; }
.foto-miniatura {
  width: 50px;
  height: 50px;
  object-fit: cover;
  border-radius: 50%;
  margin-right: 10px;
}

.navbar {
  background-color: #4CAF50; /* verde */
}

.navbar .nav-link,
.navbar .navbar-brand {
  color: #fff;
}

.navbar .nav-link:hover,
.navbar .navbar-brand:hover {
  color: #ddd;
}

.membro-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px;
  border-bottom: 1px solid #ddd;
}
.info-membro {
  display: flex;
  align-items: center;
  text-decoration: none;
  color: inherit;
  flex-grow: 1;
}
.checkbox-selecao {
  display: none;
}

/* Estilos para mensagem de n√£o autorizado */
#nao-autorizado {
  margin-top: 100px;
  max-width: 600px;
  margin-left: auto;
  margin-right: auto;
  display: none;
}

/* Oculta conte√∫do restrito por padr√£o */
.conteudo-restrito {
  display: none;
}

body.autorizado .conteudo-restrito {
  display: block;
}
</style>
</head>
<body>

<!-- Mensagem de n√£o autorizado -->
<div id="nao-autorizado">
  <div class="alert alert-danger text-center">
    <h4><i class="fas fa-exclamation-triangle me-2"></i>Acesso Restrito</h4>
    <p class="mb-4">Voc√™ n√£o tem permiss√£o para acessar esta √°rea administrativa.</p>
    <a href="index.html" class="btn btn-primary">
      <i class="fas fa-arrow-left me-2"></i>Voltar √† p√°gina inicial
    </a>
  </div>
</div>

<script type="module">
  async function checkAuthWithoutRedirect() {
    try {
      // 1. Cria um iframe oculto para executar a verifica√ß√£o
      const iframe = document.createElement('iframe');
      iframe.style.display = 'none';
      document.body.appendChild(iframe);
      
      // 2. Carrega o auth.js no iframe
      const { checkAdminAuth } = await import('./auth.js');
      
      // 3. Executa a verifica√ß√£o
      const isAdmin = await checkAdminAuth();
      
      // 4. Remove o iframe
      document.body.removeChild(iframe);
      
      return isAdmin;
    } catch (error) {
      console.error("Erro na verifica√ß√£o:", error);
      return false;
    }
  }

  document.addEventListener('DOMContentLoaded', async () => {
    try {
      const isAdmin = await checkAuthWithoutRedirect();
      
      if (isAdmin) {
        document.body.classList.add('autorizado');
      } else {
        document.getElementById('nao-autorizado').style.display = 'block';
        document.querySelectorAll('.conteudo-restrito').forEach(el => el.remove());
      }
    } catch (error) {
      console.error("Erro no carregamento:", error);
      document.getElementById('nao-autorizado').style.display = 'block';
      document.querySelectorAll('.conteudo-restrito').forEach(el => el.remove());
    }
  });
</script>
  
<!-- üîπ Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark fixed-top conteudo-restrito">
  <div class="container">
      <a class="navbar-brand" href="#">
        <i class="fas fa-list me-2"></i>Lista de Membros
      </a>
    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav me-auto">
        <!-- Bot√£o Home -->
        <li class="nav-item">
          <a class="nav-link" href="index.html">
            <i class="fas fa-home me-1"></i> Home
          </a>
        </li>
      </ul>
    </div>
  </div> 
</nav>

<div class="container mt-4 conteudo-restrito">
  <div class="mb-3 d-flex justify-content-between">
    <div>
      <button id="btnSelecionar" class="btn btn-secondary">Selecionar Cadastros</button>
      <button id="btnExportarPDF" class="btn btn-success">Exportar PDF</button>
    </div>
    <button id="btnExcluir" class="btn btn-danger d-none">Excluir Selecionados</button>
  </div>

  <!-- Mensagem de sucesso -->
  <div id="mensagemPDF"></div>

  <div id="lista-membros" class="list-group"></div>
</div>

<script type="module">
import { db } from './firebase-config.js';
import { ref, onValue, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const lista = document.getElementById("lista-membros");
const btnSelecionar = document.getElementById("btnSelecionar");
const btnExcluir = document.getElementById("btnExcluir");
let modoSelecao = false;
const membrosRef = ref(db, "membros");

function carregarMembros(data) {
  lista.innerHTML = "";
  if (!data) {
    lista.innerHTML = "<p class='text-center'>Nenhum membro cadastrado.</p>";
    return;
  }

  const membrosArray = Object.entries(data).map(([id, m]) => {
    const funcao = (m.funcao || "").toLowerCase();
    let ordemFuncao = 6;
    if (funcao === "pastor") ordemFuncao = 1;
    else if (funcao === "missionario" || funcao === "missionario(a)") ordemFuncao = 2;
    else if (funcao === "diacono") ordemFuncao = 3;
    else if (funcao === "obreiro" || funcao === "obreiro(a)") ordemFuncao = 4;
    else if (funcao === "membro") ordemFuncao = 5;

    return {
      id,
      ...m,
      ordemFuncao
    };
  });

  // ordena por ordem da fun√ß√£o e depois por nome
  membrosArray.sort((a, b) => {
    const ordemFuncao = a.ordemFuncao - b.ordemFuncao;
    if (ordemFuncao !== 0) return ordemFuncao;
    return (a.nome || "").localeCompare(b.nome || "");
  });

  for (const membro of membrosArray) {
    const item = document.createElement("div");
    item.className = "list-group-item membro-item";

    item.innerHTML = `
      <input type="checkbox" class="form-check-input me-2 checkbox-selecao" data-id="${membro.id}">
      <a href="ficha.html?id=${membro.id}" class="info-membro">
        <img src="${membro.fotoURL || ''}" class="foto-miniatura" alt="Foto">
        <div>
          <div><strong>${membro.nome}</strong></div>
          <small>${membro.funcao}</small>
        </div>
      </a>
    `;
    lista.appendChild(item);
  }

  atualizarVisibilidadeCheckboxes();
}

function atualizarVisibilidadeCheckboxes() {
  const checkboxes = document.querySelectorAll(".checkbox-selecao");
  checkboxes.forEach(cb => cb.style.display = modoSelecao ? "inline-block" : "none");
  btnExcluir.classList.toggle("d-none", !modoSelecao);
  btnSelecionar.textContent = modoSelecao ? "Cancelar Sele√ß√£o" : "Selecionar Cadastros";
}

btnSelecionar.addEventListener("click", () => {
  modoSelecao = !modoSelecao;
  atualizarVisibilidadeCheckboxes();
});

btnExcluir.addEventListener("click", () => {
  const selecionados = document.querySelectorAll(".checkbox-selecao:checked");
  if (selecionados.length === 0) return alert("Nenhum cadastro selecionado.");
  if (!confirm("Deseja excluir os cadastros selecionados?")) return;

  selecionados.forEach(cb => {
    const id = cb.getAttribute("data-id");
    remove(ref(db, `membros/${id}`));
  });
});

onValue(membrosRef, (snapshot) => {
  const data = snapshot.val();
  carregarMembros(data);
});
</script>

<script>
const btnExportarPDF = document.getElementById("btnExportarPDF");

btnExportarPDF.addEventListener("click", async () => {
  btnExportarPDF.disabled = true;
  btnExportarPDF.innerHTML = `
    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Gerando PDF...
  `;

  try {
    const doc = new window.jsPDFGlobal({ orientation: "landscape", unit: "mm", format: "a4", compress: true });
    const logoUrl = "./logo.png";
    const img = await new Promise((resolve) => {
      const img = new Image();
      img.onload = () => resolve(img);
      img.onerror = () => resolve(null);
      img.src = logoUrl;
    });

    const pageWidth = doc.internal.pageSize.getWidth();
    let startY = 15;

    if (img) {
      const logoWidth = 70;
      const logoHeight = (img.height / img.width) * logoWidth;
      const logoX = (pageWidth - logoWidth) / 2;

      doc.addImage(img, 'JPEG', logoX, 15, logoWidth, logoHeight);
      doc.setFontSize(14);
      doc.text("Fam√≠lias Vivendo na Gra√ßa e Un√ß√£o do Esp√≠rito", pageWidth / 2, 15 + logoHeight + 8, { align: "center" });
      doc.setFontSize(12);
      doc.text("Lista Completa de Membros", pageWidth / 2, 15 + logoHeight + 15, { align: "center" });

      startY = 15 + logoHeight + 25;
    }

    const { db } = await import("./firebase-config.js");
    const { get, ref, child } = await import("https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js");
    const snapshot = await get(child(ref(db), "membros"));

    if (!snapshot.exists()) {
      alert("Nenhum membro encontrado.");
      return;
    }

    const membrosArray = Object.values(snapshot.val())
    .map(m => {
      const funcao = (m.funcao || "").toLowerCase();
      let ordemFuncao = 6;
      if (funcao === "pastor") ordemFuncao = 1;
      else if (funcao === "missionario" || funcao === "missionario(a)") ordemFuncao = 2;
      else if (funcao === "diacono") ordemFuncao = 3;
      else if (funcao === "obreiro" || funcao === "obreiro(a)") ordemFuncao = 4;
      else if (funcao === "membro") ordemFuncao = 5;

      return {
        ...m,
        ordemFuncao,
        sexoFormatado: m.sexo === "M" || (m.sexo || "").toLowerCase() === "masculino" ? "Masculino" :
                       m.sexo === "F" || (m.sexo || "").toLowerCase() === "feminino" ? "Feminino" :
                       "N√£o informado",
        nomeFormatado: m.nome ? m.nome.toUpperCase() : "N√£o informado",
        funcaoFormatada: m.funcao ? m.funcao.toUpperCase() : "N√£o informado"
      };
    })
    .sort((a, b) => {
      const ordemFuncao = a.ordemFuncao - b.ordemFuncao;
      if (ordemFuncao !== 0) return ordemFuncao;
      return a.nome?.localeCompare(b.nome);
    })
    .map(m => {
      const partesEndereco = [
        m.endereco,
        m.numero && `N¬∫${m.numero}`,
        m.bairro,
        m.cidade,
        m.estado
      ].filter(Boolean);

      const enderecoCompleto = partesEndereco.join(", ");

      return [
        m.nomeFormatado,
        m.nascimento ? formatDate(m.nascimento) : "N√£o informado",
        m.sexoFormatado,
        m.telefone || "N√£o informado",
        m.funcaoFormatada,
        m.batismo ? formatDate(m.batismo) : "N√£o informado",
        enderecoCompleto
      ];
    });

    doc.autoTable({
      head: [["NOME", "NASCIM", "SEXO", "TELEFONE", "FUN√á√ÉO", "BATISMO", "ENDERE√áO"]],
      body: membrosArray,
      startY: startY,
      margin: { top: 10, bottom: 15 },
      styles: { fontSize: 10 },
      headStyles: { fillColor: [0, 128, 0], textColor: [255, 255, 255], fontSize: 10, fontStyle: 'bold' },
      columnStyles: {
        0: { cellWidth: 60 },  // Nome
        6: { cellWidth: 80 }   // Endere√ßo
      },
      didDrawPage: function(data) {
        doc.setFontSize(8);
        doc.text(`P√°gina ${data.pageNumber}`, pageWidth / 2, doc.internal.pageSize.getHeight() - 10, { align: "center" });
        const now = new Date();
        doc.text(`Gerado em: ${now.toLocaleString("pt-BR")}`, pageWidth - 10, doc.internal.pageSize.getHeight() - 10, { align: "right" });
      }
    });

    doc.save("Lista_Membros.pdf");
    mostrarMensagemPDF("‚úÖ PDF gerado com sucesso!");

  } catch (error) {
    console.error("Erro ao gerar PDF:", error);
    alert("Erro ao gerar PDF: " + error.message);
  } finally {
    btnExportarPDF.disabled = false;
    btnExportarPDF.innerHTML = `Exportar PDF`;
  }
});

function formatDate(dateString) {
  if (!dateString) return "";
  try {
    const [ano, mes, dia] = dateString.split("-");
    return `${dia}/${mes}/${ano}`;
  } catch {
    return dateString;
  }
}

function mostrarMensagemPDF(mensagem) {
  const container = document.getElementById("mensagemPDF");
  container.innerHTML = `
    <div class="alert alert-success alert-dismissible fade show mt-3" role="alert">
      ${mensagem}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  `;
}
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<script>
window.jsPDFGlobal = window.jspdf.jsPDF;
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
