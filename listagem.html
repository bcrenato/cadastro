<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lista de Membros</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { padding-top: 70px; }
    .foto-miniatura {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border-radius: 50%;
      margin-right: 10px;
    }
    .membro-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px;
      border-bottom: 1px solid #ddd;
    }
    .info-membro {
      display: flex;
      align-items: center;
      text-decoration: none;
      color: inherit;
      flex-grow: 1;
    }
    .checkbox-selecao {
      display: none;
    }
  </style>
</head>
<body>

<!-- üîí Verifica√ß√£o de autentica√ß√£o -->
<script type="module">
  import { checkAuth } from './auth.js';
  import { isUserAdmin } from './users.js';

  document.addEventListener('DOMContentLoaded', async () => {
    const user = await checkAuth();
    if (user && await isUserAdmin()) {
      document.getElementById('adminMenuItem').style.display = 'block';
    }
  });
</script>

<!-- üîπ Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
  <div class="container">
    <a class="navbar-brand" href="index.html">Listagem</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav me-auto">
        <li class="nav-item"><a class="nav-link" href="index.html">Cadastro</a></li>
        <li class="nav-item"><a class="nav-link active" href="listagem.html">Listagem</a></li>
        <li class="nav-item"><a class="nav-link" href="aniversariantes.html">Aniversariantes</a></li>
        <li class="nav-item" id="adminMenuItem" style="display: none;"><a class="nav-link" href="register.html">Cadastrar Usu√°rios</a></li>
      </ul>
      <div class="d-flex align-items-center">
        <span class="navbar-text text-white me-3"><i class="fas fa-user-circle me-1"></i> <span>Carregando...</span></span>
        <button id="logoutBtn" class="btn btn-sm btn-outline-light">Sair</button>
      </div>
    </div>
  </div>
</nav>

<!-- üîπ Conte√∫do -->
<div class="container mt-4">

  <div class="mb-3 d-flex justify-content-between">
    <div>
      <button id="btnSelecionar" class="btn btn-secondary">Selecionar Cadastros</button>
      <button id="btnExportarPDF" class="btn btn-success">Exportar PDF</button>
    </div>
    <button id="btnExcluir" class="btn btn-danger d-none">Excluir Selecionados</button>
  </div>

  <div id="lista-membros" class="list-group"></div>
</div>

<!-- üîπ Firebase + l√≥gica -->
<script type="module">
  import { db } from './firebase-config.js';
  import { ref, onValue, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

  const lista = document.getElementById("lista-membros");
  const btnSelecionar = document.getElementById("btnSelecionar");
  const btnExcluir = document.getElementById("btnExcluir");
  let modoSelecao = false;
  const membrosRef = ref(db, "membros");

  function carregarMembros(data) {
    lista.innerHTML = "";
    if (!data) {
      lista.innerHTML = "<p class='text-center'>Nenhum membro cadastrado.</p>";
      return;
    }

    for (const id in data) {
      const membro = data[id];
      const item = document.createElement("div");
      item.className = "list-group-item membro-item";

      item.innerHTML = `
        <input type="checkbox" class="form-check-input me-2 checkbox-selecao" data-id="${id}">
        <a href="ficha.html?id=${id}" class="info-membro">
          <img src="${membro.fotoURL || ''}" class="foto-miniatura" alt="Foto">
          <div>
            <div><strong>${membro.nome}</strong></div>
            <small>${membro.funcao}</small>
          </div>
        </a>
      `;

      lista.appendChild(item);
    }

    atualizarVisibilidadeCheckboxes();
  }

  function atualizarVisibilidadeCheckboxes() {
    const checkboxes = document.querySelectorAll(".checkbox-selecao");
    checkboxes.forEach(cb => cb.style.display = modoSelecao ? "inline-block" : "none");
    btnExcluir.classList.toggle("d-none", !modoSelecao);
    btnSelecionar.textContent = modoSelecao ? "Cancelar Sele√ß√£o" : "Selecionar Cadastros";
  }

  btnSelecionar.addEventListener("click", () => {
    modoSelecao = !modoSelecao;
    atualizarVisibilidadeCheckboxes();
  });

  btnExcluir.addEventListener("click", () => {
    const selecionados = document.querySelectorAll(".checkbox-selecao:checked");
    if (selecionados.length === 0) return alert("Nenhum cadastro selecionado.");
    if (!confirm("Deseja excluir os cadastros selecionados?")) return;

    selecionados.forEach(cb => {
      const id = cb.getAttribute("data-id");
      remove(ref(db, `membros/${id}`));
    });
  });

  onValue(membrosRef, (snapshot) => {
    const data = snapshot.val();
    carregarMembros(data);
  });
</script>

<!-- üîπ Exportar PDF --> 
<script> // In√≠cio do bloco de script JavaScript

  // Adiciona um event listener para o clique no bot√£o de exportar PDF
  document.getElementById("btnExportarPDF").addEventListener("click", async () => {
  try { // In√≠cio do bloco try para tratamento de erros

    // 1. Configura√ß√£o do PDF
    const doc = new window.jsPDFGlobal({ // Cria um novo documento PDF
      orientation: "landscape", // Orienta√ß√£o horizontal
      unit: "mm", // Unidade de medida em mil√≠metros
      format: "a4", // Formato A4
      compress: true // Ativa compress√£o para reduzir tamanho
    });

    // 2. Carregar a logo
    const logoUrl = "./logo.png"; // Caminho para a imagem da logo
    const img = await new Promise((resolve, reject) => { // Promessa para carregar a imagem
      const img = new Image(); // Cria um novo objeto de imagem
      img.onload = () => resolve(img); // Resolve a promessa quando a imagem carrega
      img.onerror = () => resolve(null); // Resolve com null se houver erro
      img.src = logoUrl; // Define o caminho da imagem
    });

    const pageWidth = doc.internal.pageSize.getWidth(); // Obt√©m largura da p√°gina
    let startY = 15; // Posi√ß√£o inicial padr√£o no eixo Y

    // 3. Adicionar cabe√ßalho na primeira p√°gina
    if (img) { // Se a imagem foi carregada com sucesso
      const logoWidth = 70; // Largura desejada para a logo
      const logoHeight = (img.height / img.width) * logoWidth; // Calcula altura proporcional
      const logoX = (pageWidth - logoWidth) / 2; // Calcula posi√ß√£o X para centralizar
      
      doc.addImage(img, 'JPEG', logoX, 15, logoWidth, logoHeight); // Adiciona a logo ao PDF
      doc.setFontSize(14); // Define tamanho da fonte para o t√≠tulo principal
      doc.text("Fam√≠lias Vivendo na Gra√ßa e Un√ß√£o do Esp√≠rito", pageWidth / 2, 15 + logoHeight + 8, { align: "center" }); // Adiciona t√≠tulo principal
      doc.setFontSize(12); // Define tamanho da fonte para o subt√≠tulo
      doc.text("Lista Completa de Membros", pageWidth / 2, 15 + logoHeight + 15, { align: "center" }); // Adiciona subt√≠tulo
      
      startY = 15 + logoHeight + 25; // Atualiza a posi√ß√£o Y inicial para depois do cabe√ßalho
    }

    // 4. Obter dados do Firebase
    const { db } = await import("./firebase-config.js"); // Importa configura√ß√£o do Firebase
    const { get, ref, child } = await import("https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js"); // Importa fun√ß√µes do Firebase
    const snapshot = await get(child(ref(db), "membros")); // Obt√©m dados dos membros

    if (!snapshot.exists()) { // Verifica se existem dados
      alert("Nenhum membro encontrado."); // Alerta se n√£o houver membros
      return; // Sai da fun√ß√£o
    }

    // 5. Ordenar e preparar os dados
    const membrosArray = Object.values(snapshot.val()) // Converte objeto em array
      .map(m => ({ // Mapeia cada membro
        ...m, // Copia todas as propriedades existentes
        // Define ordem de prioridade para fun√ß√µes (case insensitive)
        ordemFuncao: m.funcao?.toLowerCase() === "pastor" ? 1 : 
                    m.funcao?.toLowerCase() === "di√°cono" || m.funcao?.toLowerCase() === "diacono" ? 2 : 
                    m.funcao?.toLowerCase() === "membro" ? 3 : 4,
        // Formata sexo corretamente
        sexoFormatado: m.sexo === "M" || m.sexo?.toLowerCase() === "masculino" ? "Masculino" : 
                      m.sexo === "F" || m.sexo?.toLowerCase() === "feminino" ? "Feminino" : 
                      "N√£o informado",
        // Garante nome em mai√∫sculas
        nomeFormatado: m.nome ? m.nome.toUpperCase() : "N√£o informado",
        // Garante fun√ß√£o em mai√∫sculas
        funcaoFormatada: m.funcao ? m.funcao.toUpperCase() : "N√£o informado"
      }))
      // Ordena primeiro por fun√ß√£o, depois por nome
      .sort((a, b) => {
        const ordemFuncao = a.ordemFuncao - b.ordemFuncao; // Ordem num√©rica pela fun√ß√£o
        if (ordemFuncao !== 0) return ordemFuncao; // Se fun√ß√µes diferentes, mant√©m ordem
        return a.nome?.localeCompare(b.nome); // Se fun√ß√µes iguais, ordena por nome
      })
      .map(m => { // Mapeia para o formato final da tabela
        // Formata endere√ßo completo em UMA √öNICA LINHA
        const partesEndereco = [ // Array com partes do endere√ßo
          m.endereco, 
          m.numero && `N¬∫${m.numero}`, // N√∫mero apenas se existir
          m.bairro,
          m.cidade,
          m.estado
        ].filter(Boolean); // Remove valores vazios/nulos
        
        const enderecoCompleto = partesEndereco.join(", "); // Junta partes com v√≠rgulas
        
        return [ // Retorna array com dados formatados para a tabela
          m.nomeFormatado,
          m.nascimento ? formatDate(m.nascimento) : "N√£o informado",
          m.sexoFormatado,
          m.telefone || "N√£o informado",
          m.funcaoFormatada,
          m.batismo ? formatDate(m.batismo) : "N√£o informado",
          enderecoCompleto
        ];
      });

    // 6. Configura√ß√£o da tabela
    doc.autoTable({ // Cria tabela no PDF
      head: [["NOME", "NASCIM", "SEXO", "TELEFONE", "FUN√á√ÉO", "BATISMO", "ENDERE√áO"]], // Cabe√ßalhos
      body: membrosArray, // Dados dos membros
      startY: startY, // Posi√ß√£o inicial Y
      margin: { top: 10, bottom: 15 }, // Margens
      styles: { // Estilos gerais
        fontSize: 10, // Tamanho da fonte
        overflow: "linebreak", // Quebra de linha
        fontStyle: 'normal', // Estilo normal
        cellPadding: 2.5, // Espa√ßamento interno das c√©lulas
        lineWidth: 0.0, // Espessura da linha
        lineColor: [200, 200, 200], // Cor da linha (cinza claro 200, 200, 200)
        fillColor: [255, 255, 255], // Cor padr√£o das linhas √≠mpares (branco)
        textColor: [0, 0, 0]        // Texto preto
      },
      alternateRowStyles: {
        fillColor: [200, 200, 200], // Cinza claro para linhas pares
        textColor: [0, 0, 0]        // Texto preto
      },
      headStyles: { // Estilos do cabe√ßalho
        fillColor: [0, 128, 0], // Cor de fundo atual verde (azul 41, 128, 185)
        textColor: [255, 255, 255], // Cor do texto (branco)
        fontSize: 8, // Tamanho da fonte
        fontStyle: 'bold', // Negrito
        cellPadding: 4 // Mais espa√ßamento no cabe√ßalho
      },
      columnStyles: { // Larguras das colunas
          0: { cellWidth: 64 }, // NOME
          1: { cellWidth: 25 }, // NASCIMENTO
          2: { cellWidth: 21 }, // SEXO
          3: { cellWidth: 31 }, // TELEFONE
          4: { cellWidth: 24 }, // FUN√á√ÉO
          5: { cellWidth: 25 }, // BATISMO
          6: { cellWidth: 79 }  // ENDERE√áO
        },
      didDrawPage: function(data) { // Callback ap√≥s desenhar cada p√°gina
        doc.setFontSize(8); // Tamanho da fonte do rodap√©
        doc.text(`P√°gina ${data.pageNumber}`, pageWidth / 2, doc.internal.pageSize.getHeight() - 10, { align: "center" }); // N√∫mero da p√°gina
        
        const now = new Date(); // Data atual
        doc.text(`Gerado em: ${now.toLocaleString("pt-BR")}`, pageWidth - 10, doc.internal.pageSize.getHeight() - 10, { align: "right" }); // Data de gera√ß√£o

        if (data.pageNumber > 1) { // Ajuste para p√°ginas seguintes
          data.table.startY = 15; // Posi√ß√£o Y inicial menor
        }
      }
    });

    // 7. Salvar o PDF
    doc.save("Lista_Membros.pdf"); // Salva o PDF com o nome especificado

  } catch (error) { // Captura de erros
    console.error("Erro ao gerar PDF:", error); // Log no console
    alert("Erro ao gerar PDF: " + error.message); // Alerta para o usu√°rio
  }
});

// Fun√ß√£o para formatar datas
function formatDate(dateString) { // Recebe string de data
  if (!dateString) return ""; // Retorna vazio se n√£o houver data
  try {
    const date = new Date(dateString); // Cria objeto Date
    return date.toLocaleDateString('pt-BR', { // Formata para padr√£o brasileiro
      day: '2-digit', // Dia com 2 d√≠gitos
      month: '2-digit', // M√™s com 2 d√≠gitos
      year: 'numeric' // Ano com 4 d√≠gitos
    });
  } catch { // Se houver erro na convers√£o
    return dateString; // Retorna a string original
  }
}
</script> 



<!-- üîπ Bibliotecas externas -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<script>
  // Inicializa corretamente jsPDF e autoTable
  window.jsPDFGlobal = window.jspdf.jsPDF;
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
