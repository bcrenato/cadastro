<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lista de Membros</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <style>
    body {
      padding-top: 70px;
    }
    .foto-miniatura {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border-radius: 50%;
      margin-right: 10px;
    }
    .membro-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px;
      border-bottom: 1px solid #ddd;
    }
    .info-membro {
      display: flex;
      align-items: center;
      text-decoration: none;
      color: inherit;
      flex-grow: 1;
    }
    .checkbox-selecao {
      display: none;
    }
  </style>
</head>
<body>

  <!-- Script de verificação de autenticação -->
  <script type="module">
    import { checkAuth } from './auth.js';
    import { isUserAdmin } from './users.js';
    
    document.addEventListener('DOMContentLoaded', async () => {
      const user = await checkAuth();
      
      // Mostrar menu admin se o usuário for administrador
      if (user && await isUserAdmin()) {
        document.getElementById('adminMenuItem').style.display = 'block';
      }

      // Mostrar nome do usuário logado
      if (user) {
        document.getElementById('currentUserDisplay').querySelector('span').textContent = user.email || 'Usuário';
      }

      // Configurar logout
      document.getElementById('logoutBtn').addEventListener('click', () => {
        firebase.auth().signOut().then(() => {
          window.location.href = 'login.html';
        });
      });
    });
  </script>

  <!-- Navbar fixa no topo -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
    <div class="container">
      <a class="navbar-brand" href="index.html">Listagem</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item">
            <a class="nav-link" href="index.html">
              <i class="fas fa-user-plus me-1"></i> Cadastro
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="listagem.html">
              <i class="fas fa-list me-1"></i> Listagem
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="aniversariantes.html">
              <i class="fas fa-birthday-cake me-1"></i> Aniversariantes
            </a>
          </li>
          
          <!-- Menu de Admin (só aparece para administradores) -->
          <li class="nav-item" id="adminMenuItem" style="display: none;">
            <a class="nav-link" href="register.html">
              <i class="fas fa-user-shield me-1"></i> Cadastrar Usuários
            </a>
          </li>
        </ul>
        
        <div class="d-flex align-items-center">
          <!-- Nome do usuário logado -->
          <span class="navbar-text text-white me-3" id="currentUserDisplay">
            <i class="fas fa-user-circle me-1"></i>
            <span>Carregando...</span>
          </span>
          
          <!-- Botão de Logout -->
          <button id="logoutBtn" class="btn btn-sm btn-outline-light">
            <i class="fas fa-sign-out-alt me-1"></i> Sair
          </button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Conteúdo -->
  <div class="container mt-4">
    <!-- Botões de ação -->
    <div class="mb-3 d-flex justify-content-between">
      <button id="btnSelecionar" class="btn btn-secondary">Selecionar Cadastros</button>
      <div>
        <button id="btnExcluir" class="btn btn-danger d-none me-2">Excluir Selecionados</button>
        <button id="btnExportar" class="btn btn-success">
          <i class="fas fa-file-pdf me-1"></i> Exportar PDF
        </button>
      </div>
    </div>

    <!-- Lista de membros -->
    <div id="lista-membros" class="list-group"></div>
  </div>

  <!-- Scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <!-- Firebase + lógica -->
  <script type="module">
    import { db } from './firebase-config.js';
    import { ref, onValue, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    const lista = document.getElementById("lista-membros");
    const btnSelecionar = document.getElementById("btnSelecionar");
    const btnExcluir = document.getElementById("btnExcluir");
    const btnExportar = document.getElementById("btnExportar");
    let modoSelecao = false;

    const membrosRef = ref(db, "membros");

    // Função para carregar os membros
    function carregarMembros(data) {
      lista.innerHTML = "";

      if (!data) {
        lista.innerHTML = "<p class='text-center'>Nenhum membro cadastrado.</p>";
        return;
      }

      for (const id in data) {
        const membro = data[id];
        const item = document.createElement("div");
        item.className = "list-group-item membro-item";

        item.innerHTML = `
          <input type="checkbox" class="form-check-input me-2 checkbox-selecao" data-id="${id}">
          <a href="ficha.html?id=${id}" class="info-membro">
            <img src="${membro.fotoURL || ''}" class="foto-miniatura" alt="Foto" onerror="this.src='./sem-foto.jpg'">
            <div>
              <div><strong>${membro.nome}</strong></div>
              <small>${membro.funcao}</small>
            </div>
          </a>
        `;

        lista.appendChild(item);
      }

      atualizarVisibilidadeCheckboxes();
    }

    // Alterna visibilidade dos checkboxes
    function atualizarVisibilidadeCheckboxes() {
      const checkboxes = document.querySelectorAll(".checkbox-selecao");
      checkboxes.forEach(cb => {
        cb.style.display = modoSelecao ? "inline-block" : "none";
      });

      btnExcluir.classList.toggle("d-none", !modoSelecao);
      btnSelecionar.textContent = modoSelecao ? "Cancelar Seleção" : "Selecionar Cadastros";
    }

    // Alternar seleção
    btnSelecionar.addEventListener("click", () => {
      modoSelecao = !modoSelecao;
      atualizarVisibilidadeCheckboxes();
    });

    // Excluir selecionados
    btnExcluir.addEventListener("click", () => {
      const selecionados = document.querySelectorAll(".checkbox-selecao:checked");
      if (selecionados.length === 0) {
        alert("Nenhum cadastro selecionado.");
        return;
      }

      if (!confirm("Tem certeza que deseja excluir os cadastros selecionados?")) return;

      selecionados.forEach(cb => {
        const id = cb.getAttribute("data-id");
        remove(ref(db, `membros/${id}`));
      });
    });

    // Exportar para PDF
btnExportar.addEventListener("click", async () => {  // Adiciona evento de clique no botão Exportar PDF
  const { jsPDF } = window.jspdf;  // Obtém a biblioteca jsPDF do objeto global
  const doc = new jsPDF({  // Cria novo documento PDF
    orientation: "portrait",  // Orientação retrato
    unit: "mm",  // Unidade de medida em milímetros
    format: "a4",  // Formato A4
    compress: true  // Ativa compressão para reduzir tamanho do arquivo
  });

  // Estilos
  const styles = {  // Define estilos reutilizáveis
    titleFontSize: 16,  // Tamanho da fonte do título principal
    subtitleFontSize: 12,  // Tamanho da fonte do subtítulo
    textFontSize: 10,  // Tamanho da fonte do conteúdo
    margin: 15,  // Margem das páginas
    lineHeight: 3  // Altura da linha entre textos
  };

  // Cabeçalho
  doc.setFont("helvetica", "bold");  // Define fonte Helvetica negrito
  doc.setFontSize(styles.titleFontSize);  // Aplica tamanho do título
  doc.text("Famílias Vivendo na Graça e Unção do Espírito", 105, 20, { align: "center" });  // Adiciona título centralizado
  
  doc.setFontSize(styles.subtitleFontSize);  // Aplica tamanho do subtítulo
  doc.text("Lista Completa de Membros", 105, 28, { align: "center" });  // Adiciona subtítulo centralizado
  
  // Linha divisória
  doc.setDrawColor(200, 200, 200);  // Define cor cinza claro para a linha
  doc.setLineWidth(0.3);  // Define espessura fina da linha (0.3mm)
  doc.line(styles.margin, 35, 210 - styles.margin, 35);  // Desenha linha horizontal entre margens

  // Carrega os dados
  const snapshot = await new Promise(resolve =>  // Aguarda carregamento dos dados
    onValue(ref(db, "membros"), resolve, { onlyOnce: true })  // Obtém dados dos membros uma vez
  );
  
  const membros = [];  // Array para armazenar membros
  for (const id in snapshot.val()) {  // Itera pelos membros no banco de dados
    membros.push(snapshot.val()[id]);  // Adiciona cada membro ao array
  }

  // Ordena por nome
  membros.sort((a, b) => a.nome.localeCompare(b.nome));  // Ordena membros alfabeticamente

  // Configurações da tabela
  let yPosition = 40;  // Posição vertical inicial do conteúdo
  const col1 = styles.margin;  // Posição X da primeira coluna (margem esquerda)
  const colWidth = (210 - (2 * styles.margin)) / 2;  // Largura de cada coluna
  
  // Adiciona membros
  doc.setFont("helvetica", "normal");  // Define fonte normal para conteúdo
  doc.setFontSize(styles.textFontSize);  // Aplica tamanho da fonte do conteúdo
  
  membros.forEach((membro, index) => {  // Itera por cada membro
    // Quebra de página se necessário
    if (yPosition > 270) {  // Se atingir o final da página
      doc.addPage();  // Adiciona nova página
      yPosition = 20;  // Reinicia posição vertical
    }
    
    // Dados formatados
    const dados = [  // Array com dados formatados do membro
      `Nome: ${membro.nome || 'Não informado'}`,  // Nome ou fallback
      `Endereço: ${membro.endereco || 'Não informado'}`,  // Endereço ou fallback
      `Nascimento: ${membro.nascimento ? new Date(membro.nascimento).toLocaleDateString('pt-BR') : 'Não informado'}`,  // Data formatada
      `Batismo: ${membro.dataBatismo ? new Date(membro.dataBatismo).toLocaleDateString('pt-BR') : 'Não informado'}`,  // Data formatada
      `Função: ${membro.funcao || 'Não informado'}`,  // Função ou fallback
      `Telefone: ${membro.telefone || 'Não informado'}`,  // Telefone ou fallback
      `Sexo: ${membro.sexo === 'M' ? 'Masculino' : membro.sexo === 'F' ? 'Feminino' : 'Não informado'}`  // Sexo formatado
    ];

    // Adiciona os dados em duas colunas
    let x = col1;  // Posição X inicial (primeira coluna)
    let maxHeight = 0;  // Controla altura máxima da linha
    
    dados.forEach((texto, i) => {  // Itera por cada dado do membro
      const textHeight = doc.splitTextToSize(texto, colWidth - 5).length * styles.lineHeight;  // Calcula altura do texto
      doc.text(texto, x, yPosition, { maxWidth: colWidth - 5 });  // Adiciona texto com largura máxima
      
      if (i % 2 === 1) {  // Se for item ímpar (segunda coluna)
        yPosition += Math.max(styles.lineHeight * 2, textHeight);  // Move para próxima linha
        x = col1;  // Volta para primeira coluna
      } else {  // Se for item par (primeira coluna)
        x += colWidth;  // Move para segunda coluna
        maxHeight = Math.max(maxHeight, textHeight);  // Atualiza altura máxima
      }
    });
    
    // Linha divisória entre membros
    doc.setDrawColor(220, 220, 220);  // Cor cinza mais claro
    doc.setLineWidth(0.8);  // Espessura da linha (0.8mm)
    doc.line(styles.margin, yPosition, 210 - styles.margin, yPosition);  // Desenha linha horizontal
    
    yPosition += 10;  // Adiciona espaço após cada membro
  });

  // Rodapé
  const dataHora = new Date().toLocaleString('pt-BR', {  // Formata data e hora
    day: '2-digit',  // Dia com 2 dígitos
    month: '2-digit',  // Mês com 2 dígitos
    year: 'numeric',  // Ano com 4 dígitos
    hour: '2-digit',  // Hora com 2 dígitos
    minute: '2-digit',  // Minutos com 2 dígitos
    hour12: false  // Formato 24 horas
  }).replace(',', ' às');  // Substitui vírgula por "às"
  
  doc.setFontSize(8);  // Tamanho pequeno para rodapé
  doc.setTextColor(150, 150, 150);  // Cor cinza médio
  doc.text(`Gerado em ${dataHora} • Famílias Vivendo na Graça e Unção do Espírito`, 105, 287, { align: "center" });  // Texto centralizado no rodapé

  // Salva o PDF
  doc.save(`Lista_de_Membros_${new Date().getFullYear()}.pdf`);  // Gera e baixa o PDF
});

    // Carrega os dados do Firebase
    onValue(membrosRef, (snapshot) => {
      const data = snapshot.val();
      carregarMembros(data);
    });
  </script>
</body>
</html>
