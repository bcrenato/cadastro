<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Lista de Membros</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
body { padding-top: 70px; }
.foto-miniatura {
  width: 50px;
  height: 50px;
  object-fit: cover;
  border-radius: 50%;
  margin-right: 10px;
}
.navbar { background-color: #4CAF50; }
.navbar .nav-link, .navbar .navbar-brand { color: #fff; }
.navbar .nav-link:hover, .navbar .navbar-brand:hover { color: #ddd; }
.membro-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px;
  border-bottom: 1px solid #ddd;
}
.info-membro {
  display: flex;
  align-items: center;
  text-decoration: none;
  color: inherit;
  flex-grow: 1;
}
.checkbox-selecao { display: none; }
</style>
</head>
<body>

<!-- ðŸ”¹ Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark fixed-top">
  <div class="container">
    <a class="navbar-brand" href="#"><i class="fas fa-list me-2"></i>Lista de Membros</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav me-auto">
        <li class="nav-item">
          <a class="nav-link" href="index.html"><i class="fas fa-home me-1"></i> Home</a>
        </li>
      </ul>
    </div>
  </div> 
</nav>

<div class="container mt-4">
  <div class="mb-3 d-flex justify-content-between">
    <div>
      <button id="btnSelecionar" class="btn btn-secondary">Selecionar Cadastros</button>
      <button id="btnExportarPDF" class="btn btn-success">Exportar PDF</button>
    </div>
    <button id="btnExcluir" class="btn btn-danger d-none">Excluir Selecionados</button>
  </div>

  <div id="mensagemPDF"></div>
  <div id="lista-membros" class="list-group"></div>
</div>

<!-- ðŸš« Acesso Restrito -->
<div id="accessDenied" style="display:none; text-align:center; margin-top:100px;">
  <i class="fas fa-exclamation-triangle" style="font-size:48px;color:#f39c12;"></i>
  <h2>Acesso Restrito</h2>
  <p>Somente Administradores</p>
  <button id="goBackBtn" class="btn btn-primary mt-3">Voltar</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// Inicializa Firebase
const firebaseConfig = {
  apiKey: "AIzaSyCv6pzl34tyPTARtGxV6g2AJfkrtQeA-xU",
  authDomain: "cadastro-igreja-23042.firebaseapp.com",
  databaseURL: "https://cadastro-igreja-23042-default-rtdb.firebaseio.com",
  projectId: "cadastro-igreja-23042",
  storageBucket: "cadastro-igreja-23042.appspot.com",
  messagingSenderId: "977906864836",
  appId: "1:977906864836:web:1a21a29f4b941ac5aeaf91"
};
firebase.initializeApp(firebaseConfig);

// Verifica admin
firebase.auth().onAuthStateChanged(async (user) => {
  if (!user) {
    window.location.href = 'login.html';
    return;
  }

  const snapshot = await firebase.database()
    .ref(`users/${user.uid}/isAdmin`).get();

  if (!snapshot.exists() || snapshot.val() !== true) {
    document.querySelector('.container').style.display = 'none';
    document.getElementById('accessDenied').style.display = 'block';
  }
});

document.getElementById('goBackBtn').addEventListener('click', () => {
  if (document.referrer) {
    window.history.back();
  } else {
    window.location.href = 'index.html';
  }
});
</script>

<script type="module">
import { db } from './firebase-config.js';
import { ref, onValue, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const lista = document.getElementById("lista-membros");
const btnSelecionar = document.getElementById("btnSelecionar");
const btnExcluir = document.getElementById("btnExcluir");
let modoSelecao = false;
const membrosRef = ref(db, "membros");

function carregarMembros(data) {
  lista.innerHTML = "";
  if (!data) {
    lista.innerHTML = "<p class='text-center'>Nenhum membro cadastrado.</p>";
    return;
  }

  const membrosArray = Object.entries(data).map(([id, m]) => {
    const funcao = (m.funcao || "").toLowerCase();
    let ordemFuncao = 6;
    if (funcao === "pastor") ordemFuncao = 1;
    else if (funcao === "missionario" || funcao === "missionario(a)") ordemFuncao = 2;
    else if (funcao === "diacono") ordemFuncao = 3;
    else if (funcao === "obreiro" || funcao === "obreiro(a)") ordemFuncao = 4;
    else if (funcao === "membro") ordemFuncao = 5;

    return { id, ...m, ordemFuncao };
  });

  membrosArray.sort((a, b) => {
    const ordemFuncao = a.ordemFuncao - b.ordemFuncao;
    if (ordemFuncao !== 0) return ordemFuncao;
    return (a.nome || "").localeCompare(b.nome || "");
  });

  for (const membro of membrosArray) {
    const item = document.createElement("div");
    item.className = "list-group-item membro-item";

    item.innerHTML = `
      <input type="checkbox" class="form-check-input me-2 checkbox-selecao" data-id="${membro.id}">
      <a href="ficha.html?id=${membro.id}" class="info-membro">
        <img src="${membro.fotoURL || ''}" class="foto-miniatura" alt="Foto">
        <div>
          <div><strong>${membro.nome}</strong></div>
          <small>${membro.funcao}</small>
        </div>
      </a>
    `;
    lista.appendChild(item);
  }

  atualizarVisibilidadeCheckboxes();
}

function atualizarVisibilidadeCheckboxes() {
  const checkboxes = document.querySelectorAll(".checkbox-selecao");
  checkboxes.forEach(cb => cb.style.display = modoSelecao ? "inline-block" : "none");
  btnExcluir.classList.toggle("d-none", !modoSelecao);
  btnSelecionar.textContent = modoSelecao ? "Cancelar SeleÃ§Ã£o" : "Selecionar Cadastros";
}

btnSelecionar.addEventListener("click", () => {
  modoSelecao = !modoSelecao;
  atualizarVisibilidadeCheckboxes();
});

btnExcluir.addEventListener("click", () => {
  const selecionados = document.querySelectorAll(".checkbox-selecao:checked");
  if (selecionados.length === 0) return alert("Nenhum cadastro selecionado.");
  if (!confirm("Deseja excluir os cadastros selecionados?")) return;

  selecionados.forEach(cb => {
    const id = cb.getAttribute("data-id");
    remove(ref(db, `membros/${id}`));
  });
});

onValue(membrosRef, (snapshot) => {
  const data = snapshot.val();
  carregarMembros(data);
});
</script>

</body>
</html>
